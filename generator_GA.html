<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Admin (Compact)</title>
    <style>
        @font-face { font-family: 'Taigi Font'; src: url('./font/Charis-Regular.woff2') format('woff2'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'Taigi Font'; src: url('./font/Charis-Bold.woff2') format('woff2'); font-weight: bold; font-style: normal; }

        body { margin: 0; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f0f0; min-height: 100vh; padding-bottom: 20px; }
        
        /* VIDEO CONTAINER */
        #video-container { 
            position: relative; width: 100vw; height: calc(100vw * 9 / 16); 
            max-height: 60vh; /* Reduced max-height to save space */
            background: #000; overflow: hidden; 
        }
        #player { width: 100%; height: 100%; }
        #preview-mask { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background-color: #000; z-index: 5; pointer-events: none; }
        
        #subtitle {
            text-align: center; background: rgba(0, 0, 0, 0.4); color: white; padding: 5px 10px; width: auto; max-width: 90%;
            position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%); z-index: 10; border-radius: 4px; 
            font-family: 'Taigi Font', serif; font-size: 32px; 
            min-height: 1.2em; box-decoration-break: clone; -webkit-box-decoration-break: clone; line-height: 1.5; 
            text-shadow: 2px 2px 3px #444; 
        }
        #subtitle b { color: #fff; text-shadow: 0 0 2px #ccc; }

        /* CONTROLS GRID WRAPPER */
        #controls { 
            margin-top: 15px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* 2 Columns */
            grid-template-rows: auto auto;  /* 2 Rows */
            gap: 10px; 
            width: 98%; 
            max-width: 900px; 
        }

        /* PANELS COMMON STYLE */
        .panel { 
            background: #fff; padding: 10px; border-radius: 6px; 
            border: 1px solid #ccc; font-size: 13px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .panel h4 { margin: 0 0 8px 0; text-align: center; color: #333; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 4px;}

        /* SLIDERS COMPACT */
        .slider-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .slider-row label { width: 60px; font-weight: bold; font-size: 12px; }
        .slider-row input[type=range] { flex-grow: 1; margin: 0 8px; cursor: pointer; height: 10px; }
        .slider-row span { width: 35px; text-align: right; font-family: monospace; font-size: 11px; }
        .slider-row select { font-size: 12px; padding: 2px; }

        /* INPUTS COMPACT */
        input[type="text"], input[type="password"] { 
            padding: 4px; font-size: 12px; border: 1px solid #bbb; border-radius: 3px; width: 100%; box-sizing: border-box; margin-bottom: 4px;
        }
        
        /* BUTTONS COMPACT */
        button { 
            padding: 4px 8px; font-size: 12px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; white-space: nowrap; 
        }
        button:hover { background-color: #0056b3; }
        
        .loader-row { display: flex; gap: 5px; margin-bottom: 4px; align-items: center; }
        .loader-row input { flex-grow: 1; }

        /* SPECIFIC COLORS */
        .gh-settings { background: #fff8d6; border-color: #ffeeba; }
        .upload-btn { 
            grid-column: 1 / -1; /* Span full width at bottom */
            background-color: #dc3545; color: white; font-weight: bold; font-size: 14px; padding: 10px; 
            width: 50%; margin: 0 auto; border-radius: 5px;
        }
        .upload-btn:hover { background-color: #c82333; }

        /* HIDDEN ELEMENTS */
        #srtFile { display: none; }
        #rawContentStorage { display: none; }
        #result-area { 
            grid-column: 1 / -1; display: none; background: #e8f5e9; border: 1px solid #28a745; 
            padding: 10px; margin-top: 10px; text-align: center; border-radius: 5px;
        }
        #finalLink { width: 80%; padding: 5px; font-size: 12px; }

    </style>
</head>
<body>

    <div id="video-container">
        <div id="preview-mask"></div>
        <div id="player"></div>
        <div id="subtitle">Subtitle Preview</div>
    </div>
    <textarea id="rawContentStorage"></textarea>

    <div id="controls">
        
        <!-- C1R1: APPEARANCE -->
        <div class="panel">
            <h4>Subtitle Appearance</h4>
            <div class="slider-row"><label>Size:</label><input type="range" id="subSize" min="50" max="200" value="100" oninput="updateSubtitleStyle()"><span id="valSize">100%</span></div>
            <div class="slider-row"><label>Pos:</label><select id="subAnchor" onchange="updateSubtitleStyle()"><option value="top">Top</option><option value="bottom">Bottom</option></select><span></span></div>
            <div class="slider-row"><label>Offset:</label><input type="range" id="subOffset" min="5" max="90" value="5" oninput="updateSubtitleStyle()"><span id="valOffset">5%</span></div>
        </div>

        <!-- C2R1: MASK -->
        <div class="panel">
            <h4>Mask Settings</h4>
            <div class="slider-row"><label>Height:</label><input type="range" id="mHeight" min="0" max="100" value="0" oninput="updateMask()"></div>
            <div class="slider-row"><label>Width:</label><input type="range" id="mWidth" min="0" max="100" value="100" oninput="updateMask()"></div>
            <div class="slider-row"><label>Bottom:</label><input type="range" id="mBottom" min="0" max="100" value="0" oninput="updateMask()"></div>
            <div class="slider-row"><label>Left:</label><input type="range" id="mLeft" min="0" max="100" value="0" oninput="updateMask()"></div>
        </div>

        <!-- C1R2: GITHUB SETTINGS -->
        <div class="panel gh-settings">
            <h4>GitHub Settings</h4>
            <input type="text" id="ghUsername" placeholder="Username (e.g. hangkapiphang)" />
            <input type="text" id="ghRepo" placeholder="Repo (e.g. taigi)" />
            <input type="password" id="ghToken" placeholder="Token (ghp_...)" />
            <button onclick="saveSettings()" style="background:#ffc107; color:black; margin-top:5px;">Save Credentials</button>
        </div>

        <!-- C2R2: LOADERS -->
        <div class="panel">
            <h4>Content Loader</h4>
            <div class="loader-row">
                <input type="text" id="youtubeUrl" placeholder="YouTube URL" />
                <button onclick="loadVideo()">Load Video</button>
            </div>
            <div class="loader-row">
                <button onclick="document.getElementById('srtFile').click()" style="background:#28a745; width:100%;">Load Local .SRT</button>
                <input type="file" id="srtFile" accept=".srt" />
            </div>
            <div class="loader-row">
                <input type="text" id="subtitleUrl" placeholder="GitHub Raw URL..." />
                <button onclick="fetchSubtitleFromUrl()" style="background:#17a2b8;">Fetch</button>
            </div>
        </div>

        <!-- UPLOAD BUTTON -->
        <button class="upload-btn" onclick="uploadToGitHub()">★ UPLOAD TO GITHUB ★</button>

        <!-- RESULT -->
        <div id="result-area">
            <h4 style="margin:0; color:#28a745;">Success!</h4>
            <input type="text" id="finalLink" readonly>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const CINEMA_FILENAME = "cinema.html"; 

        function saveSettings() {
            localStorage.setItem('gh_user', document.getElementById('ghUsername').value.trim());
            localStorage.setItem('gh_repo', document.getElementById('ghRepo').value.trim());
            localStorage.setItem('gh_token', document.getElementById('ghToken').value.trim());
            alert("Saved!");
        }
        window.onload = function() {
            if(localStorage.getItem('gh_user')) document.getElementById('ghUsername').value = localStorage.getItem('gh_user');
            if(localStorage.getItem('gh_repo')) document.getElementById('ghRepo').value = localStorage.getItem('gh_repo');
            if(localStorage.getItem('gh_token')) document.getElementById('ghToken').value = localStorage.getItem('gh_token');
        }

        function updateSubtitleStyle() {
            const anchor = document.getElementById('subAnchor').value;
            const offset = document.getElementById('subOffset').value;
            const size = document.getElementById('subSize').value;
            document.getElementById('valOffset').textContent = offset + "%";
            document.getElementById('valSize').textContent = size + "%";
            const sub = document.getElementById('subtitle');
            sub.style.top = 'auto'; sub.style.bottom = 'auto';
            if (anchor === 'top') sub.style.top = offset + "%"; else sub.style.bottom = offset + "%";
            sub.style.fontSize = (32 * (size / 100)) + "px";
        }

        function updateMask() {
            const h = document.getElementById('mHeight').value; const w = document.getElementById('mWidth').value;
            const b = document.getElementById('mBottom').value; const l = document.getElementById('mLeft').value;
            const m = document.getElementById('preview-mask');
            m.style.height = h + "%"; m.style.width = w + "%"; m.style.bottom = b + "%"; m.style.left = l + "%";
        }

        async function uploadToGitHub() {
            const user = document.getElementById('ghUsername').value.trim();
            const repo = document.getElementById('ghRepo').value.trim();
            const token = document.getElementById('ghToken').value.trim();
            const videoUrl = document.getElementById('youtubeUrl').value.trim();
            const rawContent = document.getElementById('rawContentStorage').value;

            if (!user || !repo || !token) { alert("Missing GitHub Settings."); return; }
            if (!videoUrl || !rawContent) { alert("Missing Video or Subtitle."); return; }

            const id = prompt("Filename ID (no spaces):");
            if (!id) return;

            // Connection Check
            try {
                const testReq = await fetch(`https://api.github.com/repos/${user}/${repo}`, { headers: { 'Authorization': `token ${token}` } });
                if (!testReq.ok) throw new Error(`GitHub Connection Failed: ${testReq.status}`);
            } catch (e) { alert(e.message); return; }

            const maskData = { h: document.getElementById('mHeight').value, w: document.getElementById('mWidth').value, b: document.getElementById('mBottom').value, l: document.getElementById('mLeft').value };
            const settingsData = { anchor: document.getElementById('subAnchor').value, offset: document.getElementById('subOffset').value, scale: document.getElementById('subSize').value / 100 };
            
            const jsonObject = { "video": videoUrl, "subtitle": rawContent, "mask": maskData, "settings": settingsData };
            const base64Content = btoa(unescape(encodeURIComponent(JSON.stringify(jsonObject, null, 2))));
            const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/data/${id}.json`;

            try {
                let sha = null;
                // Check existing on gh-pages
                const checkReq = await fetch(apiUrl + "?ref=gh-pages", { headers: { 'Authorization': `token ${token}` } });
                if (checkReq.ok) {
                    sha = (await checkReq.json()).sha;
                    if(!confirm("File exists. Overwrite?")) return;
                }

                // Upload to gh-pages
                const uploadReq = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Update ${id}.json`,
                        content: base64Content,
                        branch: "gh-pages",
                        sha: sha
                    })
                });

                if (!uploadReq.ok) throw new Error((await uploadReq.json()).message);

                document.getElementById('result-area').style.display = 'block';
                let loc = window.location.pathname;
                let dir = loc.substring(0, loc.lastIndexOf('/'));
                document.getElementById('finalLink').value = `${window.location.origin}${dir}/${CINEMA_FILENAME}?id=${id}`;
                alert("Uploaded!");

            } catch (error) { alert("Error: " + error.message); }
        }

        let player; let subtitles = [];
        function onYouTubeIframeAPIReady() {}
        function loadVideo() {
            const url = document.getElementById('youtubeUrl').value;
            const videoId = extractVideoId(url);
            if (!videoId) { alert('Invalid URL'); return; }
            if (player) { player.loadVideoById(videoId); } else { player = new YT.Player('player', { height: '100%', width: '100%', videoId: videoId, events: { 'onReady': onPlayerReady } }); }
        }
        function extractVideoId(url) { const match = url.match(/[?&]v=([^&#]*)/) || url.match(/youtu\.be\/([^?&#]+)/); return match && match[1] ? match[1] : null; }
        function onPlayerReady(event) { setInterval(updateSubtitles, 100); }
        function updateSubtitles() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            try {
                const ct = player.getCurrentTime();
                const sub = subtitles.find(s => ct >= s.start && ct <= s.end);
                const div = document.getElementById('subtitle');
                if (sub) { div.innerHTML = sub.text; div.style.display = 'block'; } else { div.innerHTML = ''; div.style.display = 'none'; }
            } catch (e) {}
        }
        document.getElementById('srtFile').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const r = new FileReader();
            r.onload = (e) => { document.getElementById('rawContentStorage').value = e.target.result; processSubtitle(e.target.result, file.name); };
            r.readAsText(file);
        });
        function fetchSubtitleFromUrl() {
            const url = document.getElementById('subtitleUrl').value.trim(); if (!url) return;
            fetch(url).then(r=>r.text()).then(txt => { document.getElementById('rawContentStorage').value = txt; processSubtitle(txt, url); });
        }
        function processSubtitle(content, name) {
            let processed = content;
            if (name.toLowerCase().endsWith('.txt')) processed = convertTxtToSrt(content);
            document.getElementById('rawContentStorage').value = processed;
            parseSRT(processed);
            alert("Subtitle Loaded");
        }
        function parseSRT(srt) {
            subtitles = [];
            srt.trim().split(/\n\s*\n/).forEach(block => {
                const lines = block.split('\n');
                if (lines.length >= 3) {
                    const m = lines[1].match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
                    if (m) subtitles.push({ start: timeToSeconds(m[1]), end: timeToSeconds(m[2]), text: lines.slice(2).join('<br>') });
                }
            });
        }
        function convertTxtToSrt(txt) {
            if(txt.indexOf('-->') !== -1) return txt;
            const matches = [...txt.matchAll(/\[(\d+):(\d+)\]\s*(.*)/g)];
            let srt = '';
            matches.forEach((m, i) => {
                const [_, min, sec, text] = m;
                const start = `00:${min.padStart(2,'0')}:${sec.padStart(2,'0')},000`;
                let nextMin = min, nextSec = parseInt(sec) + 5;
                if(i < matches.length - 1) { nextMin = matches[i+1][1]; nextSec = matches[i+1][2]; } 
                else { if(nextSec>=60) { nextMin = parseInt(nextMin)+1; nextSec%=60; } }
                const end = `00:${nextMin.toString().padStart(2,'0')}:${nextSec.toString().padStart(2,'0')},000`;
                srt += `${i+1}\n${start} --> ${end}\n${text.trim()}\n\n`;
            });
            return srt;
        }
        function timeToSeconds(t) { const [h, m, s] = t.replace(',', '.').split(':'); return parseInt(h)*3600 + parseInt(m)*60 + parseFloat(s); }
    </script>
</body>
</html>