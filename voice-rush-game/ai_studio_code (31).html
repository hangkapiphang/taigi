<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Rush: Arcade</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@500&display=swap" rel="stylesheet">
    <!-- PeerJS for Networking -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root { --bg-color: #f0f2f5; --primary: #3498db; --danger: #e74c3c; --success: #2ecc71; --warning: #f1c40f; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        h1 { font-family: 'Bangers', cursive; margin: 10px 0; letter-spacing: 1px; }
        
        /* LAYOUT */
        .screen { width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; position: absolute; top: 0; left: 0; background: var(--bg-color); z-index: 1; }
        .screen.active { display: flex; z-index: 10; }
        .scroll-area { flex: 1; width: 100%; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding-bottom: 140px; }

        /* BUTTONS & INPUTS */
        .lobby-buttons { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; }
        .role-btn { padding: 20px; font-family: 'Bangers'; font-size: 1.8rem; border: 4px solid #333; border-radius: 15px; cursor: pointer; box-shadow: 5px 5px 0 rgba(0,0,0,0.2); width: 280px; background: #fff; transition: transform 0.1s; }
        .role-btn:active { transform: translate(2px, 2px); box-shadow: 3px 3px 0 rgba(0,0,0,0.2); }
        .big-blue { background: #3498db; color: white; }
        .big-green { background: #2ecc71; color: white; }
        .code-input { font-size: 2rem; width: 150px; text-align: center; text-transform: uppercase; padding: 10px; border: 3px solid #333; border-radius: 10px; }
        .big-input { font-size: 1.5rem; padding: 10px; border: 2px solid #333; border-radius: 10px; width: 80%; text-align: center; margin-bottom: 15px; }

        /* SETUP */
        .section-title { width: 90%; max-width: 500px; font-weight: bold; margin: 15px 0 5px 0; color: #555; text-transform: uppercase; font-size: 0.9rem; border-bottom: 2px solid #ddd; }
        .creator-box { background: white; padding: 10px; border-radius: 10px; width: 90%; max-width: 500px; display: flex; gap: 10px; margin-bottom: 10px; box-sizing: border-box; }
        input { padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 1rem; outline: none; }
        #new-emoji { width: 50px; text-align: center; cursor: pointer; background-color: #f9f9f9; font-size: 1.5rem; padding: 5px; }
        .setup-footer { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; background: white; border-top: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; gap: 10px; box-sizing: border-box; z-index: 50; }
        .footer-tools { display: flex; gap: 10px; width: 100%; max-width: 500px; }
        .btn-tool { flex: 1; padding: 8px; border: 1px solid #ccc; background: #f8f9fa; font-weight: bold; color: #555; cursor: pointer; border-radius: 5px; }
        .btn-play { background: var(--success); color: white; font-family: 'Bangers'; font-size: 2rem; padding: 10px 50px; border: 3px solid #333; border-radius: 10px; width: 100%; max-width: 400px; cursor: pointer; }
        .btn-add { background: var(--primary); color: white; border: none; font-weight: bold; padding: 0 20px; border-radius: 5px; cursor: pointer; }

        /* ITEMS (UPDATED WITH MISSING STYLES) */
        .animal-list, .library-list { width: 95%; max-width: 500px; }
        .animal-item, .library-item { background: white; margin-bottom: 8px; padding: 8px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid #ccc; }
        .animal-item.has-audio { border-left-color: var(--success); }
        .animal-info { display: flex; align-items: center; gap: 10px; }
        .animal-icon { font-size: 2rem; } 
        .animal-name { font-weight: bold; }
        .item-actions { display: flex; gap: 5px; }
        
        /* Action Buttons */
        .btn-rec, .btn-del, .btn-trash, .btn-load { border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 1rem; transition: transform 0.1s; color: white; display: flex; align-items: center; justify-content: center; }
        .btn-rec:active, .btn-del:active, .btn-load:active { transform: scale(0.95); }
        .btn-del, .btn-trash { background: var(--danger); }
        .btn-load { background: var(--primary); font-weight: bold; }
        .btn-rec { background: var(--warning); width: 40px; }
        .btn-rec.play { background: #27ae60; }
        .btn-speak { background: #3498db; }
        .lib-name { font-weight: bold; font-size: 1.1rem; }
        .lib-count { font-size: 0.8rem; color: #666; }
        
        /* REMOTE CONTROLS */
        .remote-card-display { background: white; width: 90%; padding: 10px; border-radius: 10px; border: 3px solid #333; margin-bottom: 10px; text-align: center; box-sizing: border-box; }
        .remote-controls { display: flex; flex-direction: column; gap: 10px; width: 90%; height: 60%; justify-content: center; }
        .remote-row { display: flex; gap: 10px; height: 100px; }
        .remote-btn { border: none; border-radius: 10px; font-family: 'Bangers'; font-size: 1.5rem; color: white; box-shadow: 0 4px 0 rgba(0,0,0,0.3); cursor: pointer; }
        .remote-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
        .btn-correct { background: #2ecc71; height: 160px; font-size: 2.5rem; border: 3px solid #27ae60; }
        .btn-wrong { background: #e74c3c; flex: 1; border: 3px solid #c0392b; }
        .btn-start { background: #f39c12; flex: 1; border: 3px solid #d35400; }
        .btn-next-student { background: #34495e; height: 50px; font-size: 1.2rem; }

        /* GAME UI */
        .header { width: 100%; display: flex; justify-content: space-between; padding: 10px 20px; box-sizing: border-box; font-family: 'Bangers'; font-size: 1.8rem; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr); gap: 8px; width: 95%; max-width: 600px; aspect-ratio: 2/1; margin-top: 20px; }
        .card { background: white; border: 3px solid #333; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 3.5rem; position: relative; transition: transform 0.1s; cursor: pointer; user-select: none; }
        .card.active { border-color: var(--success); box-shadow: 0 0 25px var(--success); transform: scale(1.05); z-index: 100; }
        .card.done { opacity: 0.3; filter: grayscale(100%); }
        .card.shake { animation: shake 0.4s; border-color: red; }
        .card.practice-success { background-color: #dff9fb; border-color: #2ecc71; transform: scale(0.95); }
        .timer-container { width: 90%; height: 12px; background: #ddd; border: 2px solid #333; border-radius: 10px; overflow: hidden; }
        .timer-bar { width: 100%; height: 100%; background: #f1c40f; transform-origin: left; transition: transform 0.1s linear; }
        .start-round-btn { background-color: #e67e22; color: white; font-family: 'Bangers'; font-size: 2rem; padding: 10px 40px; border: 4px solid #333; border-radius: 50px; cursor: pointer; margin-top: 15px; display: none; }
        .back-link { margin-top: 20px; text-decoration: underline; cursor: pointer; color: #555; }
        
        /* LEADERBOARD & MISC */
        .lang-toggle-container { display: flex; align-items: center; width: 90%; max-width: 500px; margin: 10px 0; background: #fff; padding: 5px; border-radius: 8px; box-sizing: border-box; }
        .lang-switch { display: flex; flex: 1; gap: 5px; }
        .lang-btn { flex: 1; border: none; padding: 8px; border-radius: 5px; background: #eee; cursor: pointer; font-weight: bold; }
        .lang-btn.active { background: var(--primary); color: white; }
        .leaderboard-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn { padding: 10px 20px; border: none; background: #ddd; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: #333; color: white; }
        .leaderboard-list { width: 90%; max-width: 500px; padding-bottom: 80px; }
        .lb-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #ccc; font-size: 1.2rem; background: white; margin-bottom: 5px; border-radius: 5px; }
        
        /* OVERLAYS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .modal-box { background: white; padding: 20px; border-radius: 15px; border: 3px solid #333; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .intermission-btn { background: #e67e22; color: white; padding: 15px 40px; font-size: 1.5rem; border: 3px solid #333; border-radius: 10px; cursor: pointer; font-family: 'Bangers'; margin-top: 20px; }
        
        /* EMOJI PICKER */
        #emoji-modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 300; display: none; justify-content: center; align-items: flex-end; }
        .emoji-drawer { background: white; width: 100%; max-width: 600px; height: 70vh; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; }
        .drawer-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .emoji-grid-container { overflow-y: auto; flex: 1; }
        .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .category-title { grid-column: 1 / -1; font-weight: bold; margin-top: 10px; color: #777; border-bottom: 1px solid #eee; }
        .emoji-btn { font-size: 2.5rem; background: #f4f4f4; border: none; border-radius: 8px; cursor: pointer; padding: 5px; }
        
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 25% { transform: translate(-1px, -2px) rotate(-1deg); } 50% { transform: translate(-3px, 0px) rotate(1deg); } 75% { transform: translate(3px, 2px) rotate(0deg); } 100% { transform: translate(1px, -1px) rotate(-1deg); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @media (max-width: 768px) { .grid { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(4, 1fr); margin-top: 10px; } .card { font-size: 2.5rem; } }
    </style>
</head>
<body>

    <!-- SCREEN 1: LOBBY -->
    <div id="screen-lobby" class="screen active">
        <h1>ü¶Å Voice Rush</h1>
        <div class="lobby-buttons" id="lobby-btns">
            <button class="role-btn big-blue" onclick="startHost()">üì∫ CLASS SCREEN<br><span>(Host)</span></button>
            <button class="role-btn big-green" onclick="showJoinMenu()">üì± TEACHER REMOTE<br><span>(Control)</span></button>
        </div>
        <div id="join-menu" style="display:none; text-align:center; margin-top:20px;">
            <input type="text" id="room-code-input" placeholder="CODE" class="code-input">
            <br><button class="btn-play" onclick="connectToHost()">CONNECT</button>
            <button onclick="hideJoinMenu()" style="display:block; margin:20px auto; background:none; border:none; text-decoration:underline;">Back</button>
        </div>
        <button onclick="goToSetup()" style="margin-top:20px; border:none; background:none; text-decoration:underline;">Edit Cards</button>
    </div>

    <!-- SCREEN 2: SETUP -->
    <div id="screen-setup" class="screen">
        <h1>üõ†Ô∏è Setup</h1>
        <div class="connection-box" style="background:#333; color:white; padding:10px; border-radius:10px; margin:10px; text-align:center;">
            <div>Code: <span id="my-room-code" style="font-family:'Bangers'; font-size:2rem; color:#f1c40f;">...</span></div>
            <div id="connection-status" style="color:orange;">Waiting...</div>
        </div>

        <div class="scroll-area">
            <div class="mode-selector" style="width:90%; max-width:500px; margin-bottom:15px;">
                <div class="section-title">Select Mode</div>
                <div style="display:flex; gap:10px;">
                    <button class="mode-btn active" id="mode-ind" onclick="setGameMode('individual')" style="flex:1; padding:15px; border:2px solid #ccc; border-radius:8px;">üë§ Solo Sprint</button>
                    <button class="mode-btn" id="mode-team" onclick="setGameMode('team')" style="flex:1; padding:15px; border:2px solid #ccc; border-radius:8px;">üë• Team Relay</button>
                </div>
            </div>

            <div class="lang-toggle-container">
                <span class="lang-label" style="font-weight:bold; margin-right:10px;">Audio:</span>
                <div class="lang-switch">
                    <button id="btn-lang-en" class="lang-btn active" onclick="setLanguage('en')">üá∫üá∏ Eng</button>
                    <button id="btn-lang-tw" class="lang-btn" onclick="setLanguage('tw')">üáπüáº Taigi</button>
                </div>
            </div>

            <div class="section-title">Active Deck</div>
            <div class="creator-box">
                <input type="text" id="new-emoji" placeholder="üòÄ" readonly onclick="openEmojiPicker()">
                <input type="text" id="new-name" placeholder="Name" style="flex:1;">
                <button class="btn-add" onclick="addNewAnimal()">+</button>
            </div>
            <div class="animal-list" id="list-container"></div>
            
            <div class="section-title">Saved Decks</div>
            <div class="library-list" id="library-container"></div>
        </div>

        <div class="setup-footer">
            <div class="footer-tools">
                <button class="btn-tool" onclick="saveCurrentDeck()">üíæ Save</button>
                <button class="btn-tool" onclick="exportData()">‚¨áÔ∏è JSON</button>
                <button class="btn-tool" onclick="triggerImport()">üìÇ Load</button>
                <input type="file" id="file-input" accept=".json" style="display:none" onchange="importData(this)">
            </div>
            <button class="btn-play" onclick="prepareGame()">PLAY ‚ñ∂</button>
        </div>
    </div>

    <!-- SCREEN 3: REMOTE -->
    <div id="screen-remote" class="screen">
        <div class="header">
            <div>üì± REMOTE</div>
            <div id="remote-score-display" style="font-weight:bold; color:#f1c40f;">0</div>
        </div>
        <audio id="remote-audio" playsinline></audio>
        <button id="enable-audio-btn" style="display:none; margin:10px auto; background:#2ecc71; color:white; border:none; padding:10px; border-radius:5px;" onclick="enableRemoteAudio()">üîá Tap to Unmute</button>
        
        <div style="font-size:0.8rem; color:#ccc; text-align:center; margin-bottom:5px;">üéß Earbuds Required</div>
        <div class="remote-card-display">
            <div id="remote-target-icon" style="font-size: 4rem;">‚ùì</div>
            <div id="remote-target-name" style="font-size: 1.5rem; font-weight: bold;">...</div>
        </div>
        <div class="remote-controls">
            <button class="remote-btn btn-correct" onclick="sendCmd('correct')">‚úÖ CORRECT</button>
            <div class="remote-row">
                <button class="remote-btn btn-wrong" onclick="sendCmd('wrong')">‚ùå WRONG</button>
                <button class="remote-btn btn-start" onclick="sendCmd('start_timer')">‚è∞ START</button>
            </div>
            <button class="remote-btn btn-next-student" onclick="sendCmd('next_round')">üéì NEXT ROUND</button>
        </div>
    </div>

    <!-- SCREEN 4: GAME -->
    <div id="screen-game" class="screen">
        <div class="header">
            <div><span id="round-display">Round 1</span></div>
            <div><span id="player-display">Player</span></div>
        </div>
        <div class="timer-container"><div class="timer-bar" id="timer-bar"></div></div>
        <div class="grid" id="grid"></div>
        <div class="status-container">
            <div id="status-text" style="text-align:center; font-weight:bold; color:#555; margin-top:10px;">Waiting...</div>
        </div>
        <button id="btn-start-round" class="start-round-btn" onclick="beginRankedRound()">‚è∞ START TIMER</button>
        <div class="back-link" onclick="goToSetup()">Quit</div>
    </div>

    <!-- SCREEN 5: LEADERBOARD -->
    <div id="screen-leaderboard" class="screen">
        <h1>üèÜ Hall of Fame</h1>
        <div class="leaderboard-tabs">
            <button class="tab-btn active" onclick="renderLeaderboard('individual')">Solo</button>
            <button class="tab-btn" onclick="renderLeaderboard('team')">Team</button>
        </div>
        <div class="leaderboard-list" id="leaderboard-content"></div>
        <div class="setup-footer">
            <div style="display:flex; gap:10px; width:100%; max-width:400px; margin-bottom:10px;">
                <button class="btn-tool" onclick="exportLeaderboard()">‚¨áÔ∏è Save Records</button>
                <button class="btn-tool" style="background:#ffdddd; color:#c0392b; border-color:#e74c3c;" onclick="clearLeaderboard()">üóëÔ∏è Reset</button>
            </div>
            <button class="btn-play" onclick="prepareGame()">NEW GAME</button>
        </div>
    </div>

    <!-- OVERLAYS -->
    <div id="emoji-modal" onclick="closeEmojiPicker(event)"><div class="emoji-drawer"><div class="drawer-header"><span style="font-weight:bold; font-size:1.2rem;">Pick Emoji</span><button onclick="togglePicker(false)" style="border:none; background:#ddd; padding:5px 15px; border-radius:20px; font-weight:bold;">Close</button></div><div class="emoji-grid-container" id="emoji-content"></div></div></div>
    
    <div id="overlay-name" class="overlay">
        <div class="modal-box">
            <h2 id="name-prompt">Who is playing?</h2>
            <input type="text" id="player-name-input" placeholder="Enter Name..." class="big-input">
            <button class="btn-play" onclick="confirmName()">GO!</button>
        </div>
    </div>

    <div id="overlay-intermission" class="overlay" style="display:none;">
        <h1 id="inter-title">ROUND 1</h1>
        <p id="inter-sub">Get Ready</p>
        <div class="score-board" id="round-scores" style="display:none;"></div>
        <button id="inter-btn" class="intermission-btn" onclick="startPractice()">READY!</button>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // CONFIG
        const ACTIVE_KEY = 'vr_data_final_v6';
        const LIBRARY_KEY = 'vr_lib_final_v6';
        const LEADERBOARD_KEY = 'vr_lb_final_v6';
        
        const ROUND_CONFIG = [
            { time: 80, label: "Round 1 (10s/card)" },
            { time: 56, label: "Round 2 (7s/card)" },
            { time: 32, label: "Round 3 (4s/card)" }
        ];
        const CARDS_PER_ROUND = 8;

        const emojis = {
            "Wild Animals": ["ü¶Å","üêØ","üêÜ","ü¶ì","ü¶í","üêò","ü¶è","ü¶õ","üêª","üêº","üê®","ü¶ä","üêó","üêä","üêÖ","ü¶ç"],
            "Fruits": ["üçé","üçå","üçá","üçâ","üçì","üçí","üçç","ü•≠","ü•ù","üçë","üçê","üçã","üçä","üçà","ü•ë"],
            "Vegetables": ["ü•¶","ü•ï","üåΩ","ü•í","üçÜ","üçÖ","ü•î","üßÖ","ü•¨","üßÑ","üå∂Ô∏è","üçÑ","ü•ú"],
            "Farm Animals": ["üê∂","üê±","üê∑","üêÆ","üêî","üê£","ü¶Ü","üê¥","üêë","üêê","üêá","ü¶É","üêÅ"],
            "Sea & Sky": ["üêô","üê¨","üê≥","ü¶à","ü¶Ä","üê¢","üê†","üê¶","ü¶Ö","ü¶â","ü¶ú","üêß","ü¶Ü","ü¶ã"],
            "Food": ["üçî","üçï","üå≠","ü•™","üç¶","üç©","üç™","üéÇ","üç´","üçø","ü•§","ü•õ","üçû","üßÄ","ü•ö"],
            "Sports": ["‚öΩ","üèÄ","üèà","‚öæ","üéæ","üèê","üèì","ü•ä","üèÜ","ü•á","üèä","üö¥"],
            "Clothing": ["üëï","üëñ","üëó","üëò","üëô","üéí","üëû","üëü","üë†","üß¢","üëí","üï∂Ô∏è","üëî"],
            "Objects": ["üöó","üöÄ","üé∏","üéà","üéÅ","üëë","üíé","‚è∞","üì±","üíª","‚úèÔ∏è","üìö"]
        };

        const PRELOADED_DECKS = {
            "Week 1: Zoo": [
                {"id": 1, "name": "lion", "icon": "ü¶Å"},
                {"id": 2, "name": "tiger", "icon": "üêÖ"},
                {"id": 3, "name": "elephant", "icon": "üêò"}
            ],
            "Week 2: Food": [
                {"id": 4, "name": "apple", "icon": "üçé"},
                {"id": 5, "name": "pizza", "icon": "üçï"}
            ]
        };

        const defaultData = [{ id: 1, name: 'dog', icon: 'üê∂' }, { id: 2, name: 'cat', icon: 'üê±' }];

        // STATE
        let currentDeck = [], deckLibrary = {}, leaderboards = { individual: [], team: [] };
        let currentLanguage = 'en', gameMode = 'individual'; 
        let peer = null, conn = null, myRoomId = "", localStream = null;
        let mediaRecorder = null, audioChunks = [];
        let currentPlayerName = "", currentRoundIdx = 0, sessionScore = 0;
        let gridData = [], activeIndex = 0, isPlaying = false, isPractice = false;
        let timerInterval, roundStartTime = 0;

        // --- INIT ---
        async function initData() {
            const sA = localStorage.getItem(ACTIVE_KEY);
            currentDeck = sA ? JSON.parse(sA) : [...defaultData];
            
            const sL = localStorage.getItem(LIBRARY_KEY);
            deckLibrary = sL ? JSON.parse(sL) : {};
            
            // Merge Preloaded if not exist
            for (const [n, c] of Object.entries(PRELOADED_DECKS)) {
                if(!deckLibrary[n]) deckLibrary[n] = c;
            }

            const sLB = localStorage.getItem(LEADERBOARD_KEY);
            leaderboards = sLB ? JSON.parse(sLB) : { individual: [], team: [] };
            
            renderActiveList();
            renderLibrary();
            initEmojiPicker();
        }

        function saveActive() { 
            try {
                localStorage.setItem(ACTIVE_KEY, JSON.stringify(currentDeck)); 
                renderActiveList(); 
            } catch(e) {
                if(e.name === 'QuotaExceededError') alert("Storage Full! Please delete recordings.");
                else console.error(e);
            }
        }

        function saveLibrary() { 
            try {
                localStorage.setItem(LIBRARY_KEY, JSON.stringify(deckLibrary)); 
                renderLibrary(); 
            } catch(e) {
                alert("Storage Full! Cannot save deck.");
            }
        }
        
        function saveLeaderboard() { localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboards)); }

        // --- UI ---
        function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function setGameMode(mode) {
            gameMode = mode;
            document.getElementById('mode-ind').classList.toggle('active', mode === 'individual');
            document.getElementById('mode-team').classList.toggle('active', mode === 'team');
        }
        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('btn-lang-en').classList.toggle('active', lang === 'en');
            document.getElementById('btn-lang-tw').classList.toggle('active', lang === 'tw');
            renderActiveList();
        }

        // --- NETWORKING ---
        function showJoinMenu() {
            document.getElementById('lobby-btns').style.display = 'none';
            document.getElementById('join-menu').style.display = 'block';
        }
        function hideJoinMenu() {
            document.getElementById('lobby-btns').style.display = 'flex';
            document.getElementById('join-menu').style.display = 'none';
        }
        function generateRoomCode() {
            const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let r = ""; for(let i=0; i<4; i++) r += c.charAt(Math.floor(Math.random() * c.length));
            return r;
        }
        function startHost() {
            if(peer) { peer.destroy(); peer = null; }
            myRoomId = generateRoomCode();
            peer = new Peer("vr-" + myRoomId);
            peer.on('open', id => { document.getElementById('my-room-code').innerText = myRoomId; switchScreen('screen-setup'); });
            peer.on('connection', c => {
                conn = c;
                document.getElementById('connection-status').innerText = "‚úÖ Teacher Connected!";
                document.getElementById('connection-status').style.color = "#2ecc71";
                conn.on('data', d => handleRemoteCommand(d));
            });
            peer.on('error', err => {
                console.error(err);
                if(err.type === 'unavailable-id') startHost(); // Retry if collision
            });
        }
        function connectToHost() {
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if(code.length !== 4) return alert("Invalid Code");
            if(peer) peer.destroy();
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect("vr-" + code);
                conn.on('open', () => { 
                    switchScreen('screen-remote'); 
                    conn.on('data', d => {
                        if(d.type === 'update_card') { document.getElementById('remote-target-icon').innerText = d.icon; document.getElementById('remote-target-name').innerText = d.name; } 
                        else if(d.type === 'score_update') { document.getElementById('remote-score-display').innerText = d.score; }
                        else if(d.type === 'game_status') { document.getElementById('remote-target-name').innerText = d.msg; }
                    });
                });
                peer.on('call', call => {
                    call.answer();
                    call.on('stream', s => { 
                        const aud = document.getElementById('remote-audio'); 
                        aud.srcObject = s; 
                        aud.play().catch(e => {
                            console.log("Audio needs click interaction", e);
                            document.getElementById('enable-audio-btn').style.display = 'block';
                        });
                    });
                });
                conn.on('error', () => alert("Host not found"));
            });
        }
        function enableRemoteAudio() {
            const aud = document.getElementById('remote-audio');
            aud.play();
            document.getElementById('enable-audio-btn').style.display = 'none';
        }
        function handleRemoteCommand(cmd) {
            if(cmd === 'correct') advanceGame(true);
            else if(cmd === 'wrong') shakeCard();
            else if(cmd === 'start_timer') beginRankedRound();
            else if(cmd === 'next_round') startPractice();
        }
        function syncToRemote(type, data) {
            if(conn && conn.open) {
                if(type === 'card') conn.send({type:'update_card', icon:data.icon, name:data.name});
                if(type === 'score') conn.send({type:'score_update', score:data});
                if(type === 'status') conn.send({type:'game_status', msg:data});
            }
        }
        function sendCmd(cmd) { if(conn && conn.open) conn.send(cmd); }

        // --- GAME LOGIC ---
        function prepareGame() {
            if(currentDeck.length < 2) return alert("Add at least 2 cards!");
            document.getElementById('player-name-input').value = "";
            document.getElementById('name-prompt').innerText = gameMode === 'individual' ? "Enter Student Name:" : "Enter Team Name:";
            document.getElementById('overlay-name').style.display = 'flex';
        }
        function confirmName() {
            const name = document.getElementById('player-name-input').value.trim();
            if(!name) return alert("Name required!");
            currentPlayerName = name;
            document.getElementById('overlay-name').style.display = 'none';
            currentRoundIdx = 0; sessionScore = 0;
            switchScreen('screen-game');
            // Init Mic
            if(!localStream && peer) navigator.mediaDevices.getUserMedia({ audio: true }).then(s => { localStream = s; if(conn) peer.call(conn.peer, s); });
            showIntermission();
        }
        function showIntermission() {
            const overlay = document.getElementById('overlay-intermission');
            document.getElementById('inter-title').innerText = gameMode==='individual' ? currentPlayerName : `TEAM: ${currentPlayerName}`;
            document.getElementById('inter-sub').innerText = `Get Ready: ${ROUND_CONFIG[currentRoundIdx].label}`;
            document.getElementById('inter-btn').innerText = "START PRACTICE";
            document.getElementById('inter-btn').onclick = startPractice;
            syncToRemote('status', `Setup: ${ROUND_CONFIG[currentRoundIdx].label}`);
            overlay.style.display = 'flex';
        }
        function startPractice() {
            document.getElementById('overlay-intermission').style.display = 'none';
            gridData = [];
            for(let i=0; i<CARDS_PER_ROUND; i++) gridData.push(currentDeck[Math.floor(Math.random() * currentDeck.length)]);
            renderGrid();
            isPractice = true; isPlaying = false;
            document.getElementById('player-display').innerText = currentPlayerName;
            document.getElementById('round-display').innerText = `R${currentRoundIdx+1}`;
            document.getElementById('status-text').innerText = "Practice Mode: Check Mic";
            document.getElementById('btn-start-round').style.display = 'block';
            document.getElementById('timer-bar').style.width = '100%';
            syncToRemote('status', "Practice Mode");
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        }
        function beginRankedRound() {
            isPractice = false; isPlaying = true;
            document.getElementById('btn-start-round').style.display = 'none';
            document.getElementById('status-text').innerText = "Game On!";
            renderGrid(); activeIndex = 0; highlightCard(0); startTimer();
        }
        function startTimer() {
            clearInterval(timerInterval);
            const timeLimit = ROUND_CONFIG[currentRoundIdx].time;
            roundStartTime = Date.now();
            timerInterval = setInterval(() => {
                if(!isPlaying) return;
                let elapsed = (Date.now() - roundStartTime) / 1000;
                let pct = 1 - (elapsed / timeLimit);
                document.getElementById('timer-bar').style.transform = `scaleX(${pct})`;
                if(pct <= 0) turnFinished(false);
            }, 50);
        }
        function turnFinished(completed) {
            isPlaying = false; clearInterval(timerInterval);
            let points = 0;
            const timeLimit = ROUND_CONFIG[currentRoundIdx].time;
            if (completed) {
                let timeUsed = (Date.now() - roundStartTime) / 1000;
                let timeLeft = Math.max(0, timeLimit - timeUsed);
                points = Math.floor(500 + (timeLeft / timeLimit) * 500);
            }
            sessionScore += points;
            syncToRemote('score', sessionScore);
            currentRoundIdx++;
            if (currentRoundIdx >= 3) finishGame(); else showIntermission();
        }
        function finishGame() {
            leaderboards[gameMode].push({ name: currentPlayerName, score: sessionScore, date: new Date().toLocaleDateString() });
            leaderboards[gameMode].sort((a,b) => b.score - a.score); 
            saveLeaderboard();
            renderLeaderboard(gameMode);
            switchScreen('screen-leaderboard');
        }

        // --- GRID & HELPERS ---
        function renderGrid() {
            const g = document.getElementById('grid'); g.innerHTML = '';
            gridData.forEach((d, i) => {
                const c = document.createElement('div');
                c.className = 'card'; c.id = `card-${i}`; c.innerHTML = d.icon;
                c.onclick = () => { if(isPractice) { speak(d); c.style.transform="scale(0.9)"; setTimeout(()=>c.style.transform="scale(1)",150); } };
                g.appendChild(c);
            });
        }
        function highlightCard(i) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            if(i < CARDS_PER_ROUND) {
                document.getElementById(`card-${i}`).classList.add('active');
                syncToRemote('card', gridData[i]);
            }
        }
        function advanceGame(isCorrect) {
            if(!isPlaying) return;
            if(isCorrect) {
                const c = document.getElementById(`card-${activeIndex}`);
                c.classList.remove('active'); c.classList.add('done'); c.style.backgroundColor='#dff9fb';
                activeIndex++;
                if(activeIndex >= CARDS_PER_ROUND) turnFinished(true); else highlightCard(activeIndex);
            }
        }
        function shakeCard() {
            if(!isPlaying) return;
            const c = document.getElementById(`card-${activeIndex}`);
            c.classList.add('shake'); setTimeout(()=>c.classList.remove('shake'),400);
        }
        function speak(item) {
            if(currentLanguage === 'en') { const u = new SpeechSynthesisUtterance(item.name); u.lang='en-US'; window.speechSynthesis.speak(u); } 
            else { if(item.audio) new Audio(item.audio).play(); }
        }

        // --- LIST MGMT ---
        function renderActiveList() {
            const c = document.getElementById('list-container'); c.innerHTML=currentDeck.length?'':'<div style="text-align:center;padding:10px;color:#999;">List Empty</div>';
            currentDeck.forEach(a => {
                const d = document.createElement('div'); d.className = `animal-item ${a.audio?'has-audio':''}`;
                let mic = '';
                if(currentLanguage==='tw') mic = a.audio ? `<button class="btn-rec play" onclick="playRecording(${a.id})">‚ñ∂</button><button class="btn-rec" style="background:#e74c3c" onclick="clearRecording(${a.id})">‚úñ</button>` : `<button class="btn-rec" id="btn-rec-${a.id}" onclick="startRecording(${a.id})">üé§</button>`;
                else mic = `<button class="btn-rec btn-speak" onclick="speak({name:'${a.name}'})">üîä</button>`;
                
                d.innerHTML = `<div class="animal-info"><div class="animal-icon">${a.icon}</div><div><div class="animal-name">${a.name}</div></div></div><div class="item-actions">${mic}<button class="btn-del" onclick="deleteAnimal(${a.id})">üóëÔ∏è</button></div>`;
                c.appendChild(d);
            });
        }
        function renderLibrary() {
            const c = document.getElementById('library-container'); const k = Object.keys(deckLibrary); c.innerHTML = k.length?'':'<div style="text-align:center;padding:10px;color:#999;">No saved decks</div>';
            k.forEach(n => {
                const d = document.createElement('div'); d.className='library-item';
                const delBtn = PRELOADED_DECKS[n] ? "" : `<button class="btn-trash" onclick="deleteDeck('${n}')">üóëÔ∏è</button>`;
                d.innerHTML = `<div><div class="lib-name">${n}</div><div class="lib-count">${deckLibrary[n].length} items</div></div><div class="item-actions"><button class="btn-load" onclick="loadDeck('${n}')">LOAD</button>${delBtn}</div>`;
                c.appendChild(d);
            });
        }
        function saveCurrentDeck(){ const n=prompt("Name:"); if(n){ deckLibrary[n]=[...currentDeck]; saveLibrary(); alert("Saved"); }}
        function loadDeck(n){ if(confirm("Load?")) { currentDeck=[...deckLibrary[n]]; saveActive(); }}
        function deleteDeck(n){ if(confirm("Delete?")) { delete deckLibrary[n]; saveLibrary(); }}
        function addNewAnimal(){ const n=document.getElementById('new-name').value; const i=document.getElementById('new-emoji').value; if(n&&i){ currentDeck.push({id:Date.now(),name:n,icon:i}); saveActive(); document.getElementById('new-name').value=''; }}
        function deleteAnimal(id){ currentDeck=currentDeck.filter(a=>a.id!==id); saveActive(); }
        async function startRecording(id){ if (!navigator.mediaDevices) return alert("Mic Error"); const s = await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder = new MediaRecorder(s); audioChunks=[]; mediaRecorder.ondataavailable=e=>audioChunks.push(e.data); mediaRecorder.onstop=()=>{ const r=new FileReader(); r.readAsDataURL(new Blob(audioChunks)); r.onloadend=()=>{ const it=currentDeck.find(x=>x.id===id); if(it){ it.audio=r.result; saveActive(); } }; s.getTracks().forEach(t=>t.stop()); }; mediaRecorder.start(); document.getElementById(`btn-rec-${id}`).innerHTML="‚èπ"; document.getElementById(`btn-rec-${id}`).onclick=()=>mediaRecorder.stop(); }
        function clearRecording(id){ if(confirm("Delete Audio?")){ const it=currentDeck.find(x=>x.id===id); if(it){ delete it.audio; saveActive(); }}}
        function playRecording(id) { const it = currentDeck.find(x => x.id === id); if(it && it.audio) new Audio(it.audio).play(); }
        function goToSetup() { isPlaying=false; switchScreen('screen-setup'); }
        function renderLeaderboard(mode) {
            const list = document.getElementById('leaderboard-content'); list.innerHTML = ""; const data = leaderboards[mode];
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(mode === 'individual') document.querySelector('.tab-btn:first-child').classList.add('active'); else document.querySelector('.tab-btn:last-child').classList.add('active');
            if(data.length === 0) { list.innerHTML = "<div style='text-align:center; padding:20px;'>No records.</div>"; return; }
            data.forEach((e, i) => {
                let m = i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":"";
                const r = document.createElement('div'); r.className = 'lb-item';
                r.innerHTML = `<div class="lb-rank">${i+1} ${m}</div><div class="lb-name">${e.name}</div><div class="lb-score">${e.score}</div>`;
                list.appendChild(r);
            });
        }
        function clearLeaderboard() { if(confirm("Reset?")) { leaderboards={individual:[],team:[]}; saveLeaderboard(); renderLeaderboard('individual'); } }
        function exportLeaderboard() { const s = JSON.stringify(leaderboards, null, 2); const b = new Blob([s],{type:"application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=`scores_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function initEmojiPicker(){ const c=document.getElementById('emoji-content'); let h=''; for(const [k,l] of Object.entries(emojis)){ h+=`<div class="category-title">${k}</div><div class="emoji-grid">`; l.forEach(x=>h+=`<button class="emoji-btn" onclick="selectEmoji('${x}')">${x}</button>`); h+='</div>'; } c.innerHTML=h; }
        function openEmojiPicker(){ document.getElementById('emoji-modal').style.display='flex'; }
        function closeEmojiPicker(e){ if(e.target.id==='emoji-modal') document.getElementById('emoji-modal').style.display='none'; }
        function togglePicker(s){ document.getElementById('emoji-modal').style.display=s?'flex':'none'; }
        function selectEmoji(c){ document.getElementById('new-emoji').value=c; togglePicker(false); }
        function exportData() { const s = JSON.stringify(currentDeck); const b = new Blob([s],{type:"application/json"}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download="deck.json"; a.click(); }
        function triggerImport() { document.getElementById('file-input').click(); }
        function importData(i) { const f = i.files[0]; const r = new FileReader(); r.onload = e => { currentDeck = JSON.parse(e.target.result); saveActive(); }; r.readAsText(f); }

        initData();
    </script>
</body>
</html>