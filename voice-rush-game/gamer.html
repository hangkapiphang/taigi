<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Rush: Arcade Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #2c3e50; font-family: 'Roboto', sans-serif; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; overflow: hidden; }
        
        /* LOGIN SCREEN */
        #login-screen { text-align: center; }
        input { font-size: 2rem; padding: 15px; border-radius: 10px; border: none; text-align: center; margin-bottom: 20px; display: block; width: 250px; }
        .btn-join { background: #f1c40f; color: #333; font-family: 'Bangers'; font-size: 2rem; padding: 15px 40px; border: none; border-radius: 10px; cursor: pointer; }
        
        /* GAME UI */
        #game-screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        
        .header { width: 100%; padding: 20px; display: flex; justify-content: space-between; font-family: 'Bangers'; font-size: 2rem; box-sizing: border-box; }
        
        .timer-bar { width: 90%; height: 15px; background: #555; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        .fill { width: 100%; height: 100%; background: #f1c40f; transition: width 0.1s linear; transform-origin: left; }
        
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 95%; max-width: 800px; aspect-ratio: 2/1; }
        .card { background: white; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 4rem; color: #333; border: 4px solid #333; transition: transform 0.2s; }
        
        .card.active { border-color: #f1c40f; box-shadow: 0 0 30px #f1c40f; transform: scale(1.05); z-index: 10; }
        .card.correct { background: #dff9fb; border-color: #2ecc71; opacity: 0.5; }
        .card.wrong { border-color: #e74c3c; animation: shake 0.4s; }
        
        @keyframes shake { 0% { transform: translate(1px, 1px); } 25% { transform: translate(-2px, -2px); } 50% { transform: translate(2px, 0px); } 75% { transform: translate(-1px, 2px); } }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <h1 style="font-family:'Bangers'; font-size:4rem; margin-bottom:20px;">Voice Rush ü¶Å</h1>
        <input type="text" id="code-input" placeholder="ROOM CODE" style="text-transform:uppercase;">
        <input type="text" id="name-input" placeholder="YOUR NAME">
        <button class="btn-join" onclick="joinGame()">JOIN GAME</button>
    </div>

    <!-- GAME -->
    <div id="game-screen">
        <div class="header">
            <span id="round-label">Waiting...</span>
            <span id="score-label">0 Pts</span>
        </div>
        <div class="timer-bar"><div class="fill" id="timer-fill"></div></div>
        <div class="grid" id="grid"></div>
        <div id="status-msg" style="margin-top:20px; font-size:1.5rem; font-weight:bold; color:#ccc;">Waiting for Teacher...</div>
    </div>

    <script>
        let peer, conn, activeIndex = 0, currentCards = [];
        let score = 0, roundTime = 80, timerInt;

        function joinGame() {
            const code = document.getElementById('code-input').value.trim().toUpperCase();
            const name = document.getElementById('name-input').value.trim();
            if(!code || !name) return alert("Fill in fields");

            peer = new Peer();
            peer.on('open', id => {
                conn = peer.connect("vr-host-" + code);
                conn.on('open', () => {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('game-screen').style.display = 'flex';
                    
                    conn.send({ type: 'join', name: name });
                    setupDataListener();
                    
                    // START AUDIO STREAMING
                    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                        peer.call(conn.peer, stream);
                    }).catch(e => console.log("Mic blocked"));
                });
                conn.on('error', () => alert("Room not found"));
            });
        }

        function setupDataListener() {
            conn.on('data', data => {
                if(data.type === 'START_ROUND') {
                    startRound(data.cards, data.time);
                }
                else if(data.type === 'JUDGE') {
                    handleJudge(data.result);
                }
                else if(data.type === 'SET_ROUND_INFO') {
                    document.getElementById('round-label').innerText = data.label;
                }
            });
        }

        function startRound(cards, time) {
            currentCards = cards;
            roundTime = time;
            activeIndex = 0;
            score = 0;
            
            // Build Grid
            const g = document.getElementById('grid');
            g.innerHTML = '';
            cards.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.id = `card-${i}`;
                div.innerHTML = c.icon;
                g.appendChild(div);
            });
            
            document.getElementById('status-msg').innerText = "GO!";
            highlight(0);
            
            // Start Timer
            const start = Date.now();
            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(() => {
                const elapsed = (Date.now() - start) / 1000;
                const pct = Math.max(0, 1 - (elapsed/roundTime));
                document.getElementById('timer-fill').style.transform = `scaleX(${pct})`;
                if(pct <= 0) clearInterval(timerInt);
            }, 50);
        }

        function handleJudge(result) {
            const card = document.getElementById(`card-${activeIndex}`);
            card.classList.remove('active');
            
            if(result === 'correct') {
                card.classList.add('correct');
                score += 100;
                document.getElementById('score-label').innerText = score + " Pts";
                conn.send({type: 'score_update', score: score});
            } else {
                card.classList.add('wrong');
                // Auto skip on wrong
            }

            activeIndex++;
            if(activeIndex < currentCards.length) {
                highlight(activeIndex);
            } else {
                clearInterval(timerInt);
                document.getElementById('status-msg').innerText = "ROUND COMPLETE!";
            }
        }

        function highlight(idx) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${idx}`).classList.add('active');
        }
    </script>
</body>
</html>
