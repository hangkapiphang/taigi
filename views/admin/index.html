<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backstage Control</title>
    <!-- Library to create ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #2c3e50; color: white; display: flex; flex-direction: column; align-items: center; padding-top: 30px; }
        h1 { margin-bottom: 20px; letter-spacing: 1px; }
        
        .container { width: 90%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; }
        
        /* CARD STYLE */
        .card { 
            background: #34495e; padding: 20px; border-radius: 10px; 
            text-decoration: none; color: white; font-size: 18px; 
            border-left: 5px solid #34495e; transition: all 0.2s;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer;
        }
        .card:hover { background: #3e5871; transform: translateX(5px); }
        
        /* COLORS */
        .card.lib   { border-left-color: #9b59b6; } /* Purple */
        .card.vocab { border-left-color: #A8C834; } /* Lime (NEW) */
        .card.edit  { border-left-color: #3498db; } /* Blue */
        .card.auto  { border-left-color: #f1c40f; } /* Yellow */
        .card.rec   { border-left-color: #e74c3c; } /* Red */
        .card.back  { border-left-color: #2ecc71; background: #27ae60; justify-content: center; font-weight: bold; }
        .card.back:hover { background: #219150; }

        .backup-area { margin-top: 20px; border-top: 1px solid #555; padding-top: 20px; text-align: center; }
        #status { font-size: 13px; color: #bdc3c7; margin-top: 10px; min-height: 20px; font-family: monospace; }
        .footer-link { margin-top: 30px; color: #95a5a6; text-decoration: none; font-size: 14px; }
        .footer-link:hover { color: white; text-decoration: underline; }
    </style>
    <script>
        if (localStorage.getItem('is_admin') !== 'true') {
            if(prompt("Enter Admin Password:") === "Taigibun") localStorage.setItem('is_admin', 'true');
            else window.location.href = "../index.html";
        }
    </script>
</head>
<body>

    <h1>‚öôÔ∏è Backstage Control</h1>

    <div class="container">
        <!-- 1. LIBRARY MANAGER -->
        <a href="library_editor.html" class="card lib">
            <span>üìö Library Manager (Edit Index)</span>
            <span>‚Üí</span>
        </a>

        <!-- 2. VOCAB EDITOR (NEW ENTRY) -->
        <a href="vocab_editor.html" class="card vocab">
            <span>üìñ Vocab Editor (Create Content)</span>
            <span>‚Üí</span>
        </a>

        <!-- 3. AUTO GENERATOR -->
        <a href="generator.html" class="card auto">
            <span>‚ö° Auto Generator (Color/Mask)</span>
            <span>‚Üí</span>
        </a>

        <!-- 4. OTHER TOOLS -->
        <a href="editor.html" class="card edit">
            <span>üìù Old Subtitle Editor</span>
            <span>‚Üí</span>
        </a>

        <a href="siongtaigi.html" class="card rec">
            <span>üî¥ Class Recorder (SiongTaigi)</span>
            <span>‚Üí</span>
        </a>

        <!-- 5. BACKUP -->
        <div class="backup-area">
            <div class="card back" onclick="backupFullProject()">
                <span>üì¶ Pack & Download All Data</span>
            </div>
            <div id="status"></div>
        </div>
    </div>

    <a href="../index.html" class="footer-link">‚Üê Back to Public Site</a>

    <script>
        async function backupFullProject() {
            const status = document.getElementById('status');
            const user = localStorage.getItem('gh_user');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');

            if (!user || !repo || !token) {
                status.style.color = '#e74c3c';
                status.innerText = "Error: Credentials missing. Go to 'Auto Generator' to save credentials.";
                return;
            }

            try {
                status.style.color = '#f1c40f';
                status.innerText = "Connecting to GitHub...";
                
                // 1. Get Branch Tip
                const branchReq = await fetch(`https://api.github.com/repos/${user}/${repo}/branches/gh-pages`, { headers: { 'Authorization': `token ${token}` } });
                if (!branchReq.ok) throw new Error("Connection failed.");
                const branchData = await branchReq.json();
                
                // 2. Get File Tree
                status.innerText = "Scanning files...";
                const treeReq = await fetch(`https://api.github.com/repos/${user}/${repo}/git/trees/${branchData.commit.sha}?recursive=1`, { headers: { 'Authorization': `token ${token}` } });
                const treeData = await treeReq.json();

                // 3. Download Files
                const zip = new JSZip();
                let count = 0;
                // Filter for json/html/css/js inside data/ css/ js/ views/
                const files = treeData.tree.filter(f => f.type === 'blob' && (f.path.startsWith('data/') || f.path.startsWith('css/') || f.path.startsWith('js/') || f.path.startsWith('views/')));

                status.innerText = `Downloading ${files.length} files...`;

                for (const file of files) {
                    const contentReq = await fetch(file.url, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3.raw' } });
                    const blob = await contentReq.blob();
                    zip.file(file.path, blob);
                    count++;
                    status.innerText = `Downloaded ${count}/${files.length}...`;
                }

                // 4. Generate Zip
                status.innerText = "Zipping...";
                const zipBlob = await zip.generateAsync({type:"blob"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(zipBlob);
                a.download = "ReelTaigi_Backup_" + new Date().toISOString().slice(0,10) + ".zip";
                a.click();
                status.innerText = "‚úÖ Backup Complete!";
                status.style.color = '#2ecc71';

            } catch (e) {
                status.style.color = '#e74c3c';
                status.innerText = "Error: " + e.message;
            }
        }
    </script>
</body>
</html>
