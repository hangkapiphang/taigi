<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Mode</title>
    <style>
        @font-face {
            font-family: 'Taigi Unicode';
            src: url('./font/Charis-Regular.woff2') format('woff2'); 
            font-weight: normal;
            font-style: normal;
        }

        body {
            margin: 0;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #video-container {
            position: relative; width: 100%; height: 100%;
            max-width: 177.78vh; max-height: 56.25vw; 
            margin: auto; background-color: #000;
        }
        #player { width: 100%; height: 100%; border: none; }
        
        #mask-bar {
            position: absolute; bottom: 0; left: 0;
            width: 100%; height: 0%; background-color: #000;
            z-index: 50; pointer-events: none; transition: all 0.5s ease;
        }

        #subtitle {
            position: absolute; top: 5%; left: 50%;
            transform: translateX(-50%); width: 98%;
            text-align: center; pointer-events: none; z-index: 100;
        }
        
        #subtitle span {
            background-color: rgba(0, 0, 0, 0.4); 
            color: #fff;
            font-family: 'Taigi Unicode', 'Times New Roman', serif;
            font-size: clamp(32px, 3vw, 55px); 
            line-height: 1.6; 
            padding: 8px 16px;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
            border-radius: 6px;
            
            /* [CHANGED] Stronger, crisper shadow */
            text-shadow: 3px 3px 2px #444444;
        }
        
        #subtitle span b { color: #fff; text-shadow: 0 0 2px white; }

        @media screen and (max-width: 768px) {
            #subtitle span {
                font-size: clamp(24px, 6vw, 40px);
                padding: 6px 10px; line-height: 1.5;
            }
        }

        #fs-btn {
            position: absolute; bottom: 10px; right: 20px; z-index: 101; 
            background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.3);
            border-radius: 4px; color: white; padding: 5px 10px; cursor: pointer;
            font-size: 14px; display: flex; align-items: center; gap: 5px;
        }
        #fs-btn svg { width: 20px; height: 20px; fill: white; }
    </style>
</head>
<body>

    <div id="video-container">
        <div id="mask-bar"></div>
        <div id="player"></div>
        <div id="subtitle"><span></span></div>
        <button id="fs-btn" onclick="toggleFullscreen()">
            <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
            Fullscreen
        </button>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player;
        let subtitles = [];

        function detectDeviceAndSetFont() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const subtitleSpan = document.querySelector('#subtitle span');
            const isIOS = /iPad|iPhone|iPod/.test(userAgent) || (navigator.userAgent.includes("Mac") && "ontouchend" in document);

            if (isIOS) {
                subtitleSpan.style.fontFamily = "'Times New Roman', serif";
            } else {
                subtitleSpan.style.fontFamily = "'Taigi Unicode', 'Times New Roman', serif";
            }
        }

        function toggleFullscreen() {
            const container = document.getElementById('video-container');
            if (!document.fullscreenElement) {
                if (container.requestFullscreen) container.requestFullscreen();
                else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
                else if (container.msRequestFullscreen) container.msRequestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
            }
        }

        function onYouTubeIframeAPIReady() {
            detectDeviceAndSetFont();
            const urlParams = new URLSearchParams(window.location.search);
            const movieId = urlParams.get('id');

            if (movieId) {
                fetch(`data/${movieId}.json`)
                    .then(r => { if(!r.ok) throw new Error("Data not found"); return r.json(); })
                    .then(data => {
                        if (data.video) {
                            const videoId = extractVideoId(data.video);
                            if (videoId) createPlayer(videoId);
                        }
                        if (data.hiddenSub) {
                            const plainText = decryptSubtitle(data.hiddenSub);
                            parseSRT(plainText);
                        }
                        
                        const mask = document.getElementById('mask-bar');
                        if (data.mask) {
                            mask.style.height = data.mask.h + "%";
                            mask.style.width  = data.mask.w + "%";
                            mask.style.bottom = data.mask.b + "%";
                            mask.style.left   = data.mask.l + "%";
                        } else if (data.maskHeight) {
                            mask.style.height = data.maskHeight + "%";
                        }
                    })
                    .catch(e => console.error(e));
            }
        }

        function createPlayer(id) {
            player = new YT.Player('player', {
                videoId: id,
                playerVars: { 
                    'autoplay': 1, 'playsinline': 1, 'controls': 1, 'rel': 0, 'start': 0,
                    'fs': 0, 'cc_load_policy': 0, 'iv_load_policy': 3 
                },
                events: { 'onReady': onPlayerReady }
            });
        }

        function onPlayerReady(event) {
            event.target.seekTo(0);
            event.target.playVideo();
            setInterval(updateSubtitles, 100);
            try { player.unloadModule("captions"); player.unloadModule("cc"); } catch (e) {}
        }

        function updateSubtitles() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            try {
                const currentTime = player.getCurrentTime();
                const subtitle = subtitles.find(s => currentTime >= s.start && currentTime <= s.end);
                const textSpan = document.querySelector('#subtitle span');
                if (subtitle) {
                    textSpan.innerHTML = subtitle.text;
                    textSpan.style.display = 'inline'; 
                } else {
                    textSpan.innerHTML = '';
                    textSpan.style.display = 'none'; 
                }
            } catch (error) {}
        }

        function decryptSubtitle(scrambled) {
            try {
                return decodeURIComponent(escape(atob(atob(scrambled).split('').reverse().join(''))));
            } catch (e) { return ""; }
        }

        function parseSRT(srtContent) {
            subtitles = [];
            const blocks = srtContent.trim().split(/\n\s*\n/);
            blocks.forEach(block => {
                const lines = block.split('\n');
                if (lines.length >= 3) {
                    const timeMatch = lines[1].match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
                    if (timeMatch) {
                        subtitles.push({
                            start: timeToSeconds(timeMatch[1]),
                            end: timeToSeconds(timeMatch[2]),
                            text: lines.slice(2).join('<br>')
                        });
                    }
                }
            });
        }

        function timeToSeconds(time) {
            const [hours, minutes, seconds] = time.replace(',', '.').split(':');
            return parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseFloat(seconds);
        }

        function extractVideoId(url) {
            const match = url.match(/[?&]v=([^&#]*)/) || url.match(/youtu\.be\/([^?&#]+)/);
            return match && match[1] ? match[1] : null;
        }
    </script>
</body>
</html>
