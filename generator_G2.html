<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Admin (GitHub API)</title>
    <style>
        @font-face {
            font-family: 'Taigi Font';
            src: url('./font/Charis-Regular.woff2') format('woff2'); 
            font-weight: normal; font-style: normal;
        }
        @font-face {
            font-family: 'Taigi Font';
            src: url('./font/Charis-Bold.woff2') format('woff2'); 
            font-weight: bold; font-style: normal;
        }

        body { margin: 0; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f0f0; min-height: 100vh; padding-bottom: 50px; }
        #video-container { position: relative; width: 100vw; height: calc(100vw * 9 / 16); max-height: 70vh; background: #000; }
        #player { width: 100%; height: 100%; }

        #preview-mask { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background-color: #000; z-index: 5; pointer-events: none; }
        
        #subtitle {
            text-align: center; 
            background: rgba(0, 0, 0, 0.4); color: white; padding: 8px 16px; width: auto; max-width: 90%;
            position: absolute; top: 5%; left: 50%; transform: translateX(-50%);
            z-index: 10; border-radius: 6px; 
            font-family: 'Taigi Font', serif;
            font-size: 32px; 
            min-height: 1.5em; box-decoration-break: clone; -webkit-box-decoration-break: clone; line-height: 1.6; 
            text-shadow: 2px 2px 3px #444; 
        }
        #subtitle b { color: #fff; text-shadow: 0 0 2px #ccc; }

        #controls { margin-top: 50px; display: flex; flex-direction: column; align-items: center; gap: 15px; width: 95%; max-width: 640px; }
        .input-group, .srt-group, .url-group { display: flex; gap: 10px; align-items: center; width: 100%; justify-content: center; flex-wrap: wrap; }
        
        .panel { background: #e9ecef; padding: 15px; border-radius: 8px; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px; border: 1px solid #ccc; }
        .gh-settings { background: #fff3cd; border: 1px solid #ffeeba; }
        
        .slider-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .slider-row label { width: 100px; font-weight: bold; }
        .slider-row input, .slider-row select { flex-grow: 1; margin: 0 10px; cursor: pointer; }
        .slider-row span { width: 40px; text-align: right; font-family: monospace; }
        
        input[type="text"], input[type="password"] { padding: 10px; font-size: 16px; border: 2px solid #ccc; border-radius: 5px; flex-grow: 1; outline: none; }
        button { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap; }
        button:hover { background-color: #0056b3; }
        .custom-file-button, .url-upload-button { background-color: #28a745; }
        .share-button { background-color: #dc3545; width: 100%; font-weight: bold; border: 2px solid #a71d2a; }
        .share-button:hover { background-color: #c82333; }
        
        #srtFile { display: none; }
        #srtFileName { padding: 10px; font-size: 14px; background: #fff; min-width: 150px; text-align: center; border-radius: 5px; }
        #result-area { display: none; width: 90%; max-width: 640px; background: #fff; border: 2px solid #28a745; padding: 20px; margin-top: 20px; border-radius: 8px; }
        textarea { width: 100%; height: 80px; display: none; } 
    </style>
</head>
<body>

    <div id="video-container">
        <div id="preview-mask"></div>
        <div id="player"></div>
        <div id="subtitle">Subtitle Preview</div>
    </div>
    
    <textarea id="rawContentStorage"></textarea>

    <div id="controls">
        <div class="panel gh-settings">
            <div style="text-align:center; font-weight:bold; color:#856404;">GitHub Auto-Upload Settings</div>
            <input type="text" id="ghUsername" placeholder="GitHub Username (e.g. hangkapiphang)" />
            <input type="text" id="ghRepo" placeholder="Repo Name (e.g. taigi)" />
            <input type="password" id="ghToken" placeholder="Token (ghp_...)" />
            <button onclick="saveSettings()" style="background:#ffc107; color:black; border:1px solid #d39e00;">Save Credentials</button>
        </div>

        <div class="input-group"><input type="text" id="youtubeUrl" placeholder="Paste YouTube Link Here..." /><button onclick="loadVideo()">1. Load Video</button></div>
        <div class="srt-group"><span id="srtFileName">No file chosen</span><input type="file" id="srtFile" accept=".srt" /> <button class="custom-file-button" onclick="document.getElementById('srtFile').click()">Load Local .srt</button></div>
        <div class="url-group"><input type="text" id="subtitleUrl" placeholder="Or Paste GitHub Raw URL..." /><button class="url-upload-button" onclick="fetchSubtitleFromUrl()">2. Fetch Text</button></div>

        <div class="panel">
            <div style="text-align:center; margin-bottom:5px; color:#333;"><strong>Subtitle Appearance</strong></div>
            <div class="slider-row"><label>Font Size:</label><input type="range" id="subSize" min="50" max="200" value="100" oninput="updateSubtitleStyle()"><span id="valSize">100%</span></div>
            <div class="slider-row"><label>Position:</label><select id="subAnchor" onchange="updateSubtitleStyle()"><option value="top">Top</option><option value="bottom">Bottom</option></select></div>
            <div class="slider-row"><label>Offset:</label><input type="range" id="subOffset" min="5" max="90" value="5" oninput="updateSubtitleStyle()"><span id="valOffset">5%</span></div>
        </div>

        <div class="panel">
            <div style="text-align:center; font-weight:bold; color:#333;">Mask Settings</div>
            <div class="slider-row"><label>Height:</label><input type="range" id="mHeight" min="0" max="100" value="0" oninput="updateMask()"></div>
            <div class="slider-row"><label>Width:</label><input type="range" id="mWidth" min="0" max="100" value="100" oninput="updateMask()"></div>
            <div class="slider-row"><label>Bottom:</label><input type="range" id="mBottom" min="0" max="100" value="0" oninput="updateMask()"></div>
            <div class="slider-row"><label>Left:</label><input type="range" id="mLeft" min="0" max="100" value="0" oninput="updateMask()"></div>
        </div>
        
        <div class="share-group"><button class="share-button" onclick="uploadToGitHub()">★ UPLOAD DIRECTLY TO GITHUB ★</button></div>
    </div>

    <div id="result-area">
        <h3 style="margin-top:0; color: #28a745;">Upload Successful!</h3>
        <p>Link to share (Wait 30s):</p>
        <input type="text" id="finalLink" readonly style="width: 100%; background: #e9ecef; font-weight: bold; color: #333; padding: 10px;">
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const CINEMA_FILENAME = "cinema.html"; 

        function saveSettings() {
            localStorage.setItem('gh_user', document.getElementById('ghUsername').value.trim());
            localStorage.setItem('gh_repo', document.getElementById('ghRepo').value.trim());
            localStorage.setItem('gh_token', document.getElementById('ghToken').value.trim());
            alert("Settings saved!");
        }
        window.onload = function() {
            if(localStorage.getItem('gh_user')) document.getElementById('ghUsername').value = localStorage.getItem('gh_user');
            if(localStorage.getItem('gh_repo')) document.getElementById('ghRepo').value = localStorage.getItem('gh_repo');
            if(localStorage.getItem('gh_token')) document.getElementById('ghToken').value = localStorage.getItem('gh_token');
        }

        function updateSubtitleStyle() {
            const anchor = document.getElementById('subAnchor').value;
            const offset = document.getElementById('subOffset').value;
            const size = document.getElementById('subSize').value;
            document.getElementById('valOffset').textContent = offset + "%";
            document.getElementById('valSize').textContent = size + "%";
            const sub = document.getElementById('subtitle');
            sub.style.top = 'auto'; sub.style.bottom = 'auto';
            if (anchor === 'top') sub.style.top = offset + "%"; else sub.style.bottom = offset + "%";
            sub.style.fontSize = (32 * (size / 100)) + "px";
        }

        function updateMask() {
            const h = document.getElementById('mHeight').value; const w = document.getElementById('mWidth').value;
            const b = document.getElementById('mBottom').value; const l = document.getElementById('mLeft').value;
            const m = document.getElementById('preview-mask');
            m.style.height = h + "%"; m.style.width = w + "%"; m.style.bottom = b + "%"; m.style.left = l + "%";
        }

        async function uploadToGitHub() {
            // 1. Get and Clean Credentials
            const user = document.getElementById('ghUsername').value.trim();
            const repo = document.getElementById('ghRepo').value.trim();
            const token = document.getElementById('ghToken').value.trim();
            const videoUrl = document.getElementById('youtubeUrl').value.trim();
            const rawContent = document.getElementById('rawContentStorage').value;

            if (!user || !repo || !token) { alert("Please fill in GitHub Settings first."); return; }
            if (!videoUrl || !rawContent) { alert("Please load Video and Subtitles first."); return; }

            const id = prompt("Create a filename ID:");
            if (!id) return;

            // 2. Prepare Data
            const maskData = { h: document.getElementById('mHeight').value, w: document.getElementById('mWidth').value, b: document.getElementById('mBottom').value, l: document.getElementById('mLeft').value };
            const settingsData = { anchor: document.getElementById('subAnchor').value, offset: document.getElementById('subOffset').value, scale: document.getElementById('subSize').value / 100 };
            
            const jsonObject = { "video": videoUrl, "subtitle": rawContent, "mask": maskData, "settings": settingsData };
            const jsonString = JSON.stringify(jsonObject, null, 2);
            
            // Base64 Encode (Unicode Safe)
            const base64Content = btoa(unescape(encodeURIComponent(jsonString)));
            const path = `data/${id}.json`;
            const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;

            try {
                // 3. CHECK FILE EXISTENCE (Targeting gh-pages branch specifically)
                let sha = null;
                const checkReq = await fetch(apiUrl + "?ref=gh-pages", { 
                    headers: { 'Authorization': `token ${token}` } 
                });
                
                if (checkReq.ok) {
                    const fileData = await checkReq.json();
                    sha = fileData.sha; 
                    if(!confirm(`File '${id}.json' already exists on gh-pages. Overwrite?`)) return;
                } else if (checkReq.status !== 404) {
                    // Real error, not just "missing file"
                    const errTxt = await checkReq.json();
                    throw new Error(`GitHub Check Error: ${errTxt.message}`);
                }

                // 4. UPLOAD / UPDATE (Targeting gh-pages branch specifically)
                const putBody = {
                    message: `Create/Update ${id}.json via Generator`,
                    content: base64Content,
                    branch: "gh-pages" // <--- CRITICAL FIX
                };
                if (sha) putBody.sha = sha;

                const uploadReq = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(putBody)
                });

                if (!uploadReq.ok) {
                    const err = await uploadReq.json();
                    throw new Error(`Upload Failed: ${err.message}`);
                }

                // 5. SUCCESS
                document.getElementById('result-area').style.display = 'block';
                let loc = window.location.pathname;
                let dir = loc.substring(0, loc.lastIndexOf('/'));
                document.getElementById('finalLink').value = `${window.location.origin}${dir}/${CINEMA_FILENAME}?id=${id}`;
                alert("Success! File uploaded to gh-pages branch.");

            } catch (error) {
                alert(error.message);
                console.error(error);
            }
        }

        let player; let subtitles = [];
        function onYouTubeIframeAPIReady() {}
        function loadVideo() {
            const url = document.getElementById('youtubeUrl').value;
            const videoId = extractVideoId(url);
            if (!videoId) { alert('Invalid URL'); return; }
            if (player) { player.loadVideoById(videoId); } else { player = new YT.Player('player', { height: '100%', width: '100%', videoId: videoId, events: { 'onReady': onPlayerReady } }); }
        }
        function extractVideoId(url) { const match = url.match(/[?&]v=([^&#]*)/) || url.match(/youtu\.be\/([^?&#]+)/); return match && match[1] ? match[1] : null; }
        function onPlayerReady(event) { setInterval(updateSubtitles, 100); }
        function updateSubtitles() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            try {
                const ct = player.getCurrentTime();
                const sub = subtitles.find(s => ct >= s.start && ct <= s.end);
                const div = document.getElementById('subtitle');
                if (sub) { div.innerHTML = sub.text; div.style.display = 'block'; } else { div.innerHTML = ''; div.style.display = 'none'; }
            } catch (e) {}
        }
        document.getElementById('srtFile').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            document.getElementById('srtFileName').textContent = file.name;
            const r = new FileReader();
            r.onload = (e) => { document.getElementById('rawContentStorage').value = e.target.result; processSubtitle(e.target.result, file.name); };
            r.readAsText(file);
        });
        function fetchSubtitleFromUrl() {
            const url = document.getElementById('subtitleUrl').value.trim(); if (!url) return;
            fetch(url).then(r=>r.text()).then(txt => {
                document.getElementById('srtFileName').textContent = "Loaded URL";
                document.getElementById('rawContentStorage').value = txt; processSubtitle(txt, url);
            });
        }
        function processSubtitle(content, name) {
            let processed = content;
            if (name.toLowerCase().endsWith('.txt')) processed = convertTxtToSrt(content);
            document.getElementById('rawContentStorage').value = processed;
            parseSRT(processed);
            alert("Subtitle Loaded");
        }
        function parseSRT(srt) {
            subtitles = [];
            srt.trim().split(/\n\s*\n/).forEach(block => {
                const lines = block.split('\n');
                if (lines.length >= 3) {
                    const m = lines[1].match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
                    if (m) subtitles.push({ start: timeToSeconds(m[1]), end: timeToSeconds(m[2]), text: lines.slice(2).join('<br>') });
                }
            });
        }
        function convertTxtToSrt(txt) {
            if(txt.indexOf('-->') !== -1) return txt;
            const matches = [...txt.matchAll(/\[(\d+):(\d+)\]\s*(.*)/g)];
            let srt = '';
            matches.forEach((m, i) => {
                const [_, min, sec, text] = m;
                const start = `00:${min.padStart(2,'0')}:${sec.padStart(2,'0')},000`;
                let nextMin = min, nextSec = parseInt(sec) + 5;
                if(i < matches.length - 1) { nextMin = matches[i+1][1]; nextSec = matches[i+1][2]; } 
                else { if(nextSec>=60) { nextMin = parseInt(nextMin)+1; nextSec%=60; } }
                const end = `00:${nextMin.toString().padStart(2,'0')}:${nextSec.toString().padStart(2,'0')},000`;
                srt += `${i+1}\n${start} --> ${end}\n${text.trim()}\n\n`;
            });
            return srt;
        }
        function timeToSeconds(t) { const [h, m, s] = t.replace(',', '.').split(':'); return parseInt(h)*3600 + parseInt(m)*60 + parseFloat(s); }
    </script>
</body>
</html>