<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taigi Arcade</title>
    <style>
        @font-face { font-family: 'Taigi Font'; src: url('./font/Charis-Regular.woff2') format('woff2'); }
        
        body { margin: 0; font-family: 'Taigi Font', Arial, sans-serif; background: #2c3e50; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* HEADER */
        header { width: 100%; padding: 15px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .score-board { font-size: 20px; font-weight: bold; color: #f1c40f; }
        
        /* GAME AREA */
        #game-container { width: 90%; max-width: 800px; margin-top: 20px; text-align: center; }
        
        /* VIDEO (Hidden or Small) */
        #video-wrapper { 
            width: 300px; aspect-ratio: 16/9; margin: 0 auto 20px; border-radius: 10px; overflow: hidden; border: 2px solid #555; 
            /* Optional: Hide video to make it "Listening Only" */
            /* opacity: 0; */ 
        }
        #player { width: 100%; height: 100%; }

        /* QUESTION CARD */
        .card { background: white; color: #333; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        .question-text { font-size: 28px; margin-bottom: 20px; line-height: 1.6; }
        .blank { border-bottom: 3px solid #e74c3c; color: #e74c3c; padding: 0 10px; font-weight: bold; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        
        .opt-btn { 
            background: #ecf0f1; border: 2px solid #bdc3c7; color: #2c3e50; 
            padding: 15px; font-size: 20px; border-radius: 8px; cursor: pointer; 
            font-family: 'Taigi Font'; transition: all 0.2s;
        }
        .opt-btn:hover { background: #dfe6e9; transform: translateY(-2px); }
        .opt-btn.correct { background: #2ecc71; border-color: #27ae60; color: white; }
        .opt-btn.wrong { background: #e74c3c; border-color: #c0392b; color: white; }

        .controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .ctrl-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .replay { background: #f39c12; color: white; }
        .next { background: #3498db; color: white; display: none; } /* Hidden initially */

        /* End Screen */
        #end-screen { display: none; text-align: center; margin-top: 50px; }
        .home-btn { display: inline-block; margin-top: 20px; color: white; text-decoration: none; border: 1px solid white; padding: 10px 20px; border-radius: 5px; }
    </style>
</head>
<body>

    <header>
        <div>ðŸŽ® Listening Quiz</div>
        <div class="score-board">Score: <span id="score">0</span></div>
    </header>

    <!-- GAME PLAY AREA -->
    <div id="game-container">
        <div id="video-wrapper"><div id="player"></div></div>
        
        <div class="card">
            <div class="question-text" id="question">Loading...</div>
            <div class="options-grid" id="options"></div>
            
            <div class="controls">
                <button class="ctrl-btn replay" onclick="replayClip()">ðŸ”Š Replay Audio</button>
                <button class="ctrl-btn next" id="nextBtn" onclick="nextQuestion()">Next Question âž¡</button>
            </div>
        </div>
    </div>

    <!-- GAME OVER AREA -->
    <div id="end-screen">
        <h1>Great Job!</h1>
        <h2>Final Score: <span id="final-score">0</span></h2>
        <a href="index.html" class="home-btn">Return to Menu</a>
        <button class="home-btn" onclick="location.reload()" style="background:#27ae60; border:none;">Play Again</button>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player;
        let allLines = [];
        let currentQuestion = null;
        let score = 0;
        let roundsPlayed = 0;
        const TOTAL_ROUNDS = 5; // How many questions per game

        // 1. Setup YouTube
        function onYouTubeIframeAPIReady() {
            const id = new URLSearchParams(window.location.search).get('id');
            if(id) loadGameData(id);
        }

        function loadGameData(id) {
            fetch(`data/${id}.json?t=${Date.now()}`).then(r=>r.json()).then(data => {
                const vidId = extractVideoId(data.video);
                // Create player (invisible mostly)
                player = new YT.Player('player', {
                    videoId: vidId,
                    playerVars: { 'controls': 0, 'disablekb': 1, 'fs': 0 },
                    events: { 'onReady': () => parseAndStart(data.subtitle || decrypt(data.hiddenSub)) }
                });
            });
        }

        // 2. Parse Subtitles & Prepare Game
        function parseAndStart(srt) {
            // Convert SRT to Array
            srt.trim().split(/\n\s*\n/).forEach(block => {
                const lines = block.split('\n');
                if(lines.length >= 3) {
                    const m = lines[1].match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
                    if(m) {
                        // Clean HTML tags for the game text
                        const cleanText = lines.slice(2).join(' ').replace(/<[^>]*>/g, '');
                        // Only use lines long enough to be a question
                        if(cleanText.length > 5) {
                            allLines.push({
                                start: timeToSec(m[1]),
                                end: timeToSec(m[2]),
                                text: cleanText
                            });
                        }
                    }
                }
            });
            nextQuestion();
        }

        // 3. Game Engine
        function nextQuestion() {
            if(roundsPlayed >= TOTAL_ROUNDS) { endGame(); return; }
            roundsPlayed++;

            // Reset UI
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('options').innerHTML = '';
            
            // Pick Random Line
            const randomIdx = Math.floor(Math.random() * allLines.length);
            const line = allLines[randomIdx];
            
            // Tokenize (Split by space or punctuation logic)
            // Simple split by space for now
            const words = line.text.split(' ');
            
            // Find a target word (length > 1)
            let targetWord = "";
            let targetIndex = -1;
            
            // Try to find a good word to hide
            for(let i=0; i<10; i++) {
                const idx = Math.floor(Math.random() * words.length);
                if(words[idx].length > 1) {
                    targetWord = words[idx];
                    targetIndex = idx;
                    break;
                }
            }
            if(targetIndex === -1) { nextQuestion(); return; } // Try again if bad line

            // Build Question String
            const qWords = [...words];
            qWords[targetIndex] = '<span class="blank">______</span>';
            document.getElementById('question').innerHTML = qWords.join(' ');

            // Generate Options (1 Correct + 3 Random from other lines)
            let options = [targetWord];
            while(options.length < 4) {
                const rLine = allLines[Math.floor(Math.random() * allLines.length)].text;
                const rWord = rLine.split(' ')[Math.floor(Math.random() * rLine.split(' ').length)];
                if(!options.includes(rWord) && rWord.length > 1) options.push(rWord);
            }
            options = shuffle(options);

            // Render Buttons
            const optDiv = document.getElementById('options');
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.textContent = opt;
                btn.onclick = () => checkAnswer(btn, opt, targetWord);
                optDiv.appendChild(btn);
            });

            currentQuestion = line;
            replayClip();
        }

        function checkAnswer(btn, selected, correct) {
            // Disable all buttons
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.disabled = true);

            if(selected === correct) {
                btn.classList.add('correct');
                score += 10;
                document.getElementById('score').textContent = score;
                // Play success sound?
            } else {
                btn.classList.add('wrong');
                // Highlight correct one
                allBtns.forEach(b => { if(b.textContent === correct) b.classList.add('correct'); });
            }
            document.getElementById('nextBtn').style.display = 'block';
        }

        // 4. Video Control
        let stopTimer;
        function replayClip() {
            if(!currentQuestion) return;
            player.seekTo(currentQuestion.start, true);
            player.playVideo();
            
            // Stop when clip ends
            const duration = (currentQuestion.end - currentQuestion.start) * 1000;
            clearTimeout(stopTimer);
            stopTimer = setTimeout(() => {
                player.pauseVideo();
            }, duration + 500); // Add 0.5s buffer
        }

        function endGame() {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('end-screen').style.display = 'block';
            document.getElementById('final-score').textContent = score;
        }

        // Utils
        function extractVideoId(url) { const m = url.match(/[?&]v=([^&#]*)/) || url.match(/youtu\.be\/([^?&#]+)/); return m && m[1] ? m[1] : null; }
        function decrypt(s) { try { return decodeURIComponent(escape(atob(atob(s).split('').reverse().join('')))); } catch(e){return"";} }
        function timeToSec(t) { const [h,m,s] = t.replace(',','.').split(':'); return parseInt(h)*3600 + parseInt(m)*60 + parseFloat(s); }
        function shuffle(a) { for(let i=a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    </script>
</body>
</html>