<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Mode</title>
    <style>
        @font-face { font-family: 'Taigi Font'; src: url('./font/Charis-Regular.woff2') format('woff2'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'Taigi Font'; src: url('./font/Charis-Bold.woff2') format('woff2'); font-weight: bold; font-style: normal; }

        body { margin: 0; background-color: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #video-container { position: relative; width: 100%; height: 100%; max-width: 177.78vh; max-height: 56.25vw; margin: auto; background-color: #000; }
        #player { width: 100%; height: 100%; border: none; }
        #mask-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background-color: #000; z-index: 50; pointer-events: none; transition: all 0.5s ease; }
        
        #subtitle { position: absolute; top: 5%; left: 50%; transform: translateX(-50%); width: 98%; text-align: center; pointer-events: none; z-index: 100; }
        
        #subtitle span { 
            background-color: rgba(0, 0, 0, 0.4); 
            color: #fff; font-family: 'Taigi Font', serif; 
            font-size: clamp(32px, 3vw, 55px); line-height: 1.6; padding: 4px 8px; 
            box-decoration-break: clone; -webkit-box-decoration-break: clone; border-radius: 6px; 
            text-shadow: 2px 2px 3px #444; 
        }
        #subtitle span b { color: #fff; text-shadow: 0 0 2px #ccc; }

        @media screen and (max-width: 768px) { #subtitle span { font-size: clamp(24px, 6vw, 40px); padding: 2px 6px; line-height: 1.5; } }
        
        #fs-btn { position: absolute; bottom: 10px; right: 20px; z-index: 101; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; color: white; padding: 5px 10px; cursor: pointer; font-size: 14px; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
        #fs-btn:hover { background: rgba(255,255,255,0.2); border-color: white; }
        #fs-btn svg { width: 20px; height: 20px; fill: white; }
    </style>
</head>
<body>
    <div id="video-container">
        <div id="mask-bar"></div>
        <div id="player"></div>
        <div id="subtitle"><span></span></div>
        <button id="fs-btn" onclick="toggleFullscreen()">
            <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>Fullscreen
        </button>
    </div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player; let subtitles = [];
        
        function toggleFullscreen() {
            const c = document.getElementById('video-container');
            if (!document.fullscreenElement) { if (c.requestFullscreen) c.requestFullscreen(); else if (c.webkitRequestFullscreen) c.webkitRequestFullscreen(); } 
            else { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); }
        }
        
        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }

        function onYouTubeIframeAPIReady() {
            const movieId = new URLSearchParams(window.location.search).get('id');
            if (movieId) {
                fetch(`data/${movieId}.json?t=${new Date().getTime()}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.video) createPlayer(extractVideoId(data.video));
                        if (data.subtitle) parseSRT(data.subtitle);
                        else if (data.hiddenSub) parseSRT(decryptSubtitle(data.hiddenSub)); 
                        
                        const m = document.getElementById('mask-bar');
                        if (data.mask) { 
                            m.style.height = data.mask.h + "%"; 
                            m.style.width = data.mask.w + "%"; 
                            m.style.bottom = data.mask.b + "%"; 
                            m.style.left = data.mask.l + "%"; 
                            if(data.mask.c) m.style.backgroundColor = data.mask.c;
                            if(data.mask.o) m.style.opacity = data.mask.o;
                        }
                        
                        if (data.settings || data.subtitlePos) {
                            const set = data.settings || data.subtitlePos;
                            const sub = document.getElementById('subtitle');
                            const span = document.querySelector('#subtitle span');
                            
                            // Position
                            if (set.anchor) {
                                sub.style.top = 'auto'; sub.style.bottom = 'auto';
                                if (set.anchor === 'top') sub.style.top = set.offset + "%"; else sub.style.bottom = set.offset + "%";
                            }
                            // Scale
                            if (set.scale) applyFontScale(set.scale);
                            // Text Color
                            if (set.color) span.style.color = set.color;
                            
                            // Box Color & Opacity
                            if (set.boxColor && set.boxOp !== undefined) {
                                const rgb = hexToRgb(set.boxColor);
                                span.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${set.boxOp})`;
                            }
                            
                            // Shadow
                            if (set.shadow !== undefined) {
                                const s = set.shadow;
                                const shadowCol = set.shadowColor || "#000000"; // Fallback to black
                                if (s == 0) span.style.textShadow = "none";
                                else span.style.textShadow = `${s}px ${s}px ${s}px ${shadowCol}`;
                            }
                        }
                    })
                    .catch(e => console.error(e));
            }
        }
        
        function applyFontScale(ratio) {
            const pc = `clamp(${32*ratio}px, ${3*ratio}vw, ${55*ratio}px)`;
            const mob = `clamp(${24*ratio}px, ${6*ratio}vw, ${40*ratio}px)`;
            const style = document.createElement('style');
            style.innerHTML = `#subtitle span { font-size: ${pc} !important; } @media screen and (max-width: 768px) { #subtitle span { font-size: ${mob} !important; } }`;
            document.head.appendChild(style);
        }

        function createPlayer(id) {
            player = new YT.Player('player', { videoId: id, playerVars: { 'autoplay': 1, 'playsinline': 1, 'controls': 1, 'rel': 0, 'start': 0, 'fs': 0, 'cc_load_policy': 0, 'iv_load_policy': 3 }, events: { 'onReady': onPlayerReady } });
        }
        function onPlayerReady(event) { event.target.seekTo(0); event.target.playVideo(); setInterval(updateSubtitles, 100); try{ player.unloadModule("captions"); }catch(e){} }
        function updateSubtitles() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            const ct = player.getCurrentTime();
            const sub = subtitles.find(s => ct >= s.start && ct <= s.end);
            const span = document.querySelector('#subtitle span');
            if (sub) { span.innerHTML = sub.text; span.style.display = 'inline'; } else { span.innerHTML = ''; span.style.display = 'none'; }
        }
        function decryptSubtitle(scrambled) { try { return decodeURIComponent(escape(atob(atob(scrambled).split('').reverse().join('')))); } catch (e) { return ""; } }
        function parseSRT(srt) {
            subtitles = [];
            srt.trim().split(/\n\s*\n/).forEach(block => {
                const lines = block.split('\n');
                if (lines.length >= 3) {
                    const m = lines[1].match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
                    if (m) subtitles.push({ start: timeToSeconds(m[1]), end: timeToSeconds(m[2]), text: lines.slice(2).join('<br>').replace(/-/g, 'â€‘') });
                }
            });
        }
        function timeToSeconds(t) { const [h, m, s] = t.replace(',', '.').split(':'); return parseInt(h)*3600 + parseInt(m)*60 + parseFloat(s); }
        function extractVideoId(url) { const m = url.match(/[?&]v=([^&#]*)/) || url.match(/youtu\.be\/([^?&#]+)/); return m && m[1] ? m[1] : null; }
    </script>
</body>
</html>