<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Editor</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f4f4f4; }
        
        /* Header & Status */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; }
        #status { font-weight: bold; color: #555; }

        /* Main List Area */
        #list-area { display: flex; flex-direction: column; gap: 15px; }

        /* Individual Movie Card Styling */
        .row { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            display: flex; 
            gap: 15px;
            align-items: flex-start;
        }

        /* Thumbnails & Move Buttons */
        .actions { display: flex; flex-direction: column; align-items: center; min-width: 120px; }
        .thumb-preview { width: 120px; height: 68px; object-fit: cover; border-radius: 4px; background: #ddd; }
        
        /* Form Inputs */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .form-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 2px; }
        input, select { width: 100%; padding: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .full-width { width: 100%; }

        /* Buttons */
        .btn { cursor: pointer; padding: 5px 10px; border: none; border-radius: 4px; }
        .btn-move { background: #eee; }
        .btn-move:hover { background: #ddd; }
        .btn-del { background: #ffcccc; color: #cc0000; margin-top: auto; }
        .btn-del:hover { background: #ffaaaa; }
        
        .main-btn { padding: 10px 20px; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 5px; }
        .btn-add { background: #28a745; }
        .btn-save { background: #007bff; }
        .btn-add:hover { background: #218838; }
        .btn-save:hover { background: #0069d9; }

        .toolbar { margin-top: 30px; display: flex; gap: 10px; padding-bottom: 50px;}
    </style>
</head>
<body>

    <header>
        <h1>üé¨ Library Editor</h1>
        <div id="status">Initializing...</div>
    </header>

    <div id="list-area"></div>

    <div class="toolbar">
        <button class="main-btn btn-add" onclick="addItem()">+ Add New Movie</button>
        <button class="main-btn btn-save" onclick="saveToGitHub()">üíæ Save & Publish</button>
    </div>

    <script>
        let libraryData = [];
        let currentSHA = null; 

        // --- 1. INITIAL LOAD ---
        window.onload = function() {
            const user = localStorage.getItem('gh_user');
            const token = localStorage.getItem('gh_token');
            
            if(!user || !token) {
                if(confirm("Credentials Missing! Go to Generator page?")) {
                    window.location.href = "generator.html";
                }
            } else {
                loadFromGitHub();
            }
        }

        // --- 2. GITHUB API: READ ---
        async function loadFromGitHub() {
            const user = localStorage.getItem('gh_user');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const status = document.getElementById('status');

            status.innerText = "Connecting...";
            
            // NOTE: We look for data/library.json on the 'gh-pages' branch
            const url = `https://api.github.com/repos/${user}/${repo}/contents/data/library.json?ref=gh-pages`;

            try {
                const req = await fetch(url, { 
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Cache-Control': 'no-cache' 
                    } 
                });
                
                if (req.status === 404) {
                    status.innerText = "File not found. Starting fresh.";
                    libraryData = [];
                    currentSHA = null;
                    renderList();
                    return;
                }

                if (!req.ok) throw new Error(`GitHub API Error: ${req.status} ${req.statusText}`);
                
                const data = await req.json();
                currentSHA = data.sha; // STORE THE SHA HERE
                
                const jsonString = decodeURIComponent(escape(atob(data.content)));
                libraryData = JSON.parse(jsonString);
                
                renderList();
                status.innerText = "‚úÖ Loaded!";

            } catch (err) {
                console.error(err);
                status.innerText = "Error loading data.";
                alert("Failed to Load!\n\nReason: " + err.message);
            }
        }

        // --- 3. RENDER UI ---
        function renderList() {
            const container = document.getElementById('list-area');
            container.innerHTML = "";

            if (libraryData.length === 0) {
                container.innerHTML = "<div style='text-align:center; padding:20px; color:#777; background:white;'>No movies in library yet. Click '+ Add New Movie'.</div>";
                return;
            }

            libraryData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'row';
                div.innerHTML = `
                    <div class="actions">
                        <img src="https://img.youtube.com/vi/${item.yt}/hqdefault.jpg" class="thumb-preview" id="thumb-${index}" onerror="this.src='https://via.placeholder.com/120x68?text=No+Img'">
                        <div style="display:flex; gap:5px; justify-content:center; margin-top:5px;">
                            <button class="btn btn-move" onclick="moveItem(${index}, -1)">‚ñ≤</button>
                            <button class="btn btn-move" onclick="moveItem(${index}, 1)">‚ñº</button>
                        </div>
                    </div>

                    <div style="flex-grow:1;">
                        <div class="input-grid">
                            <div class="form-group">
                                <label>JSON Filename (ID)</label>
                                <input type="text" value="${item.id || ''}" onchange="updateItem(${index}, 'id', this.value)" placeholder="ironman">
                            </div>
                            <div class="form-group">
                                <label>YouTube ID</label>
                                <input type="text" value="${item.yt || ''}" onchange="updateItem(${index}, 'yt', this.value)" placeholder="e.g. 8ugaeA-nMTc">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select onchange="updateItem(${index}, 'cat', this.value)">
                                    <option value="song" ${item.cat === 'song' ? 'selected' : ''}>üéµ Song</option>
                                    <option value="cartoon" ${item.cat === 'cartoon' ? 'selected' : ''}>üß∏ Cartoon</option>
                                    <option value="speech" ${item.cat === 'speech' ? 'selected' : ''}>üé§ Speech</option>
                                    <option value="drama" ${item.cat === 'drama' ? 'selected' : ''}>üé≠ Drama</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="full-width" value="${item.title || ''}" onchange="updateItem(${index}, 'title', this.value)">
                        </div>
                        
                        <div class="form-group" style="margin-top:10px;">
                            <label>Description</label>
                            <input type="text" class="full-width" value="${item.desc || ''}" onchange="updateItem(${index}, 'desc', this.value)">
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-del" onclick="deleteItem(${index})">Delete</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- 4. DATA OPERATIONS ---
        function updateItem(index, field, value) {
            libraryData[index][field] = value;
            if(field === 'yt') {
                const img = document.getElementById(`thumb-${index}`);
                if(value.length > 5) img.src = `https://img.youtube.com/vi/${value}/hqdefault.jpg`;
            }
        }

        function addItem() {
            libraryData.push({
                id: "",
                title: "New Video Title",
                desc: "Description here...",
                cat: "cartoon",
                yt: "",
                date: new Date().toISOString().slice(0, 10)
            });
            renderList();
            setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
        }

        function deleteItem(index) {
            if(confirm("Remove this movie?")) {
                libraryData.splice(index, 1);
                renderList();
            }
        }

        function moveItem(index, direction) {
            if (index + direction < 0 || index + direction >= libraryData.length) return;
            const temp = libraryData[index];
            libraryData[index] = libraryData[index + direction];
            libraryData[index + direction] = temp;
            renderList();
        }

        // --- 5. GITHUB API: SAVE (FIXED) ---
        async function saveToGitHub() {
            const user = localStorage.getItem('gh_user');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const status = document.getElementById('status');

            if (!confirm("This will update the live website menu. Continue?")) return;

            status.innerText = "Checking file version...";

            // 1. GET LATEST SHA (The Fix)
            // Even if we loaded it before, we check again to be safe and ensure 'currentSHA' is valid.
            const getUrl = `https://api.github.com/repos/${user}/${repo}/contents/data/library.json?ref=gh-pages`;
            try {
                const getReq = await fetch(getUrl, { 
                    headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' } 
                });
                
                if (getReq.ok) {
                    const getData = await getReq.json();
                    currentSHA = getData.sha; // Update the SHA variable
                    console.log("Latest SHA found:", currentSHA);
                } else if (getReq.status === 404) {
                    currentSHA = null; // File doesn't exist yet, that's fine
                }
            } catch (e) {
                console.warn("Could not fetch latest SHA, trying blindly...", e);
            }

            status.innerText = "Saving...";

            const url = `https://api.github.com/repos/${user}/${repo}/contents/data/library.json`;
            const jsonString = JSON.stringify(libraryData, null, 2);
            const content = btoa(unescape(encodeURIComponent(jsonString)));

            const body = {
                message: "Update Library Menu via Editor",
                content: content,
                branch: "gh-pages"
            };

            // Only attach SHA if we found one
            if (currentSHA) {
                body.sha = currentSHA;
            }

            try {
                const req = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!req.ok) {
                    const err = await req.json();
                    throw new Error(err.message);
                }
                
                const res = await req.json();
                currentSHA = res.content.sha;
                status.innerText = "‚úÖ Saved!";
                alert("Menu Updated! It will appear on the site in ~1 minute.");

            } catch (err) {
                console.error(err);
                status.innerText = "‚ùå Save Failed";
                alert("Error: " + err.message);
            }
        }
    </script>
</body>
</html>