<!DOCTYPE html>
<html lang="en">
<head>
    <script>
    // Simple Gatekeeper
    if (localStorage.getItem('is_admin') !== 'true') {
        const pass = prompt("Restricted Area. Enter Admin Password:");
        if (pass === "taigibun") { // <--- CHANGE "1234" TO YOUR PASSWORD
            localStorage.setItem('is_admin', 'true');
        } else {
            alert("Access Denied");
            window.location.href = "../index.html"; // Send them back to safety
        }
    }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema 4-Window Editor</title>
    <style>
        /* FONTS */
        @font-face { font-family: 'Taigi Font'; src: url('../font/Charis-Regular.woff2') format('woff2'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'Taigi Font'; src: url('../font/Charis-Bold.woff2') format('woff2'); font-weight: bold; font-style: normal; }

        /* MAIN LAYOUT */
        body { 
            margin: 0; font-family: Arial, sans-serif; background-color: #e0e0e0; 
            height: 100vh; overflow: hidden; 
            display: grid;
            /* 2 Columns: 65% (Video/List) | 35% (Settings) */
            grid-template-columns: 65% 35%; 
            /* 2 Rows: 60% (Video) | 40% (Editor) - Adjusted for footer */
            grid-template-rows: 55vh 1fr 60px; 
            gap: 5px; padding: 5px; box-sizing: border-box;
        }

        /* --- WINDOW 1: TOP LEFT (VIDEO) --- */
        #win-video {
            grid-column: 1; grid-row: 1;
            background: #000; position: relative; border-radius: 8px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        #video-wrapper { position: relative; width: 100%; aspect-ratio: 16/9; max-height: 100%; }
        #player { width: 100%; height: 100%; }
        #preview-mask { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background-color: #000; z-index: 5; pointer-events: none; }
        #subtitle {
            text-align: center; background: rgba(0, 0, 0, 0.4); color: white; padding: 4px 8px; width: auto; max-width: 90%;
            position: absolute; top: 5%; left: 50%; transform: translateX(-50%); z-index: 10; border-radius: 4px; 
            font-family: 'Taigi Font', serif; font-size: 32px; 
            min-height: 1.2em; box-decoration-break: clone; -webkit-box-decoration-break: clone; line-height: 1.5; 
            text-shadow: 2px 2px 3px #444; 
        }
        #subtitle b { color: #fff; text-shadow: 0 0 2px #ccc; }

        /* --- WINDOW 2: TOP RIGHT (APPEARANCE) --- */
        #win-appearance {
            grid-column: 2; grid-row: 1;
            background: #fff; padding: 15px; border-radius: 8px; overflow-y: auto; border: 1px solid #ccc;
        }

        /* --- WINDOW 3: BOTTOM LEFT (EDITOR LIST - BIG) --- */
        #win-editor {
            grid-column: 1; grid-row: 2;
            background: #fff; border-radius: 8px; border: 1px solid #ccc;
            display: flex; flex-direction: column; overflow: hidden;
        }
        #editor-toolbar { padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; gap: 10px; }
        #rows-area { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        .sub-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eee; background: #fdfdfd; }
        .sub-row:hover { background-color: #e3f2fd; }
        .active-row { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .time-input { width: 80px; font-family: monospace; font-size: 13px; padding: 4px; border: 1px solid #ccc; border-radius: 3px; }
        .text-input { flex-grow: 1; padding: 6px; font-size: 15px; border: 1px solid #ccc; border-radius: 3px; font-family: 'Taigi Font'; }
        .btn-icon { cursor: pointer; border: none; background: none; font-size: 16px; opacity: 0.6; }
        .btn-icon:hover { opacity: 1; transform: scale(1.2); }

        /* --- WINDOW 4: BOTTOM RIGHT (MASK) --- */
        #win-mask {
            grid-column: 2; grid-row: 2;
            background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ccc; overflow-y: auto;
        }

        /* --- FOOTER (GLOBAL SETTINGS) --- */
        #footer {
            grid-column: 1 / -1; grid-row: 3;
            background: #343a40; color: white; display: flex; align-items: center; padding: 0 15px; gap: 15px; border-radius: 8px;
        }

        /* UI ELEMENTS */
        h4 { margin: 0 0 10px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #333; }
        .slider-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .slider-row label { width: 80px; font-weight: bold; }
        .slider-row input[type=range] { flex-grow: 1; cursor: pointer; }
        input[type="color"] { width: 30px; height: 25px; border: none; background: none; cursor: pointer; }
        
        .gh-input { background: #495057; border: 1px solid #6c757d; color: white; padding: 5px; border-radius: 3px; width: 120px; font-size: 12px; }
        .btn-action { padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; color: white; }
        .btn-load { background: #17a2b8; }
        .btn-save { background: #28a745; }
        .btn-gh { background: #dc3545; }
        #hidden-file { display: none; }
    </style>
</head>
<body>

    <!-- 1. TOP LEFT: VIDEO SCREEN -->
    <div id="win-video">
        <div id="video-wrapper">
            <div id="preview-mask"></div>
            <div id="player"></div>
            <div id="subtitle">Subtitle Preview</div>
        </div>
    </div>

    <!-- 2. TOP RIGHT: APPEARANCE -->
    <div id="win-appearance">
        <h4>Subtitle Appearance</h4>
        <div class="slider-row"><label>Text Color:</label><input type="color" id="subColor" value="#ffffff" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Box Color:</label><input type="color" id="subBoxColor" value="#000000" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Box Opacity:</label><input type="range" id="subBoxOp" min="0" max="100" value="40" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Shadow:</label><input type="color" id="subShadowColor" value="#444444" oninput="updatePreview()"><input type="range" id="subShadow" min="0" max="10" value="2" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Size:</label><input type="range" id="subSize" min="50" max="200" value="100" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Position:</label><select id="subAnchor" onchange="updatePreview()"><option value="top">Top</option><option value="bottom">Bottom</option></select></div>
        <div class="slider-row"><label>Offset:</label><input type="range" id="subOffset" min="5" max="90" value="5" oninput="updatePreview()"></div>
    </div>

    <!-- 3. BOTTOM LEFT: EDITOR (BIG) -->
    <div id="win-editor">
        <div id="editor-toolbar">
            <input type="text" id="videoUrl" placeholder="Paste YouTube URL..." style="flex-grow:1; padding:5px;">
            <button onclick="loadVideo(document.getElementById('videoUrl').value)">Load Video</button>
            <button onclick="addSubtitleLine()" style="background:#28a745; color:white; border:none; padding:5px 10px; border-radius:3px;">+ New Line</button>
        </div>
        <div id="rows-area">
            <div style="padding:20px; text-align:center; color:#888;">Load a JSON file or add lines to start editing.</div>
        </div>
    </div>

    <!-- 4. BOTTOM RIGHT: MASK -->
    <div id="win-mask">
        <h4>Mask Settings</h4>
        <div class="slider-row"><label>Color:</label><input type="color" id="mColor" value="#000000" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Opacity:</label><input type="range" id="mOpacity" min="0" max="100" value="100" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Height:</label><input type="range" id="mHeight" min="0" max="100" value="0" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Width:</label><input type="range" id="mWidth" min="0" max="100" value="100" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Bottom:</label><input type="range" id="mBottom" min="0" max="100" value="0" oninput="updatePreview()"></div>
        <div class="slider-row"><label>Left:</label><input type="range" id="mLeft" min="0" max="100" value="0" oninput="updatePreview()"></div>
    </div>

    <!-- FOOTER: SAVE & GITHUB -->
    <div id="footer">
        <button class="btn-action btn-load" onclick="document.getElementById('hidden-file').click()">üìÇ Load JSON</button>
        <input type="file" id="hidden-file" accept=".json" onchange="loadLocalJson(this)">
        <button class="btn-action btn-save" onclick="downloadJson()">üíæ Download</button>
        
        <div style="width:2px; height:30px; background:#555; margin:0 10px;"></div>
        
        <input type="text" class="gh-input" id="ghUser" placeholder="GH User">
        <input type="text" class="gh-input" id="ghRepo" placeholder="Repo">
        <input type="password" class="gh-input" id="ghToken" placeholder="Token">
        <button class="btn-action btn-gh" onclick="uploadToGithub()">‚òÅ Upload to GitHub</button>
        <button onclick="saveGh()" style="font-size:10px; background:none; color:#bbb; border:1px solid #555; cursor:pointer;">Save Keys</button>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player;
        let subtitleData = []; 

        // --- INIT ---
        window.onload = function() {
            if(localStorage.getItem('gh_user')) document.getElementById('ghUser').value = localStorage.getItem('gh_user');
            if(localStorage.getItem('gh_repo')) document.getElementById('ghRepo').value = localStorage.getItem('gh_repo');
            if(localStorage.getItem('gh_token')) document.getElementById('ghToken').value = localStorage.getItem('gh_token');
        }

        // --- PLAYER ---
        function onYouTubeIframeAPIReady() {}
        function loadVideo(url) {
            const id = extractVideoId(url);
            if(!id) return;
            if(player) player.loadVideoById(id);
            else player = new YT.Player('player', { height: '100%', width: '100%', videoId: id, events: {'onReady': e=>setInterval(checkTime, 100)} });
        }
        function extractVideoId(url) { const m = url.match(/[?&]v=([^&#]*)/) || url.match(/youtu\.be\/([^?&#]+)/); return m && m[1] ? m[1] : null; }
        
        function checkTime() {
            if(!player || !player.getCurrentTime) return;
            const ct = player.getCurrentTime();
            // Highlight active row in editor
            document.querySelectorAll('.sub-row').forEach(row => row.classList.remove('active-row'));
            
            const sub = subtitleData.find((s, idx) => {
                const match = ct >= s.start && ct <= s.end;
                if(match) {
                    const row = document.getElementById(`row-${idx}`);
                    if(row) row.classList.add('active-row');
                }
                return match;
            });
            
            const div = document.getElementById('subtitle');
            if(sub) { div.innerHTML = sub.text; div.style.display = 'block'; }
            else { div.innerHTML = ''; div.style.display = 'none'; }
        }

        // --- EDITOR GRID ---
        function renderEditor() {
            const container = document.getElementById('rows-area');
            container.innerHTML = '';
            subtitleData.forEach((sub, index) => {
                const row = document.createElement('div');
                row.className = 'sub-row';
                row.id = `row-${index}`;
                row.innerHTML = `
                    <button class="btn-icon" style="color:green" onclick="seekTo(${sub.start})">‚ñ∂</button>
                    <input type="text" class="time-input" value="${secToTime(sub.start)}" onchange="updateData(${index}, 'start', this.value)">
                    <input type="text" class="time-input" value="${secToTime(sub.end)}" onchange="updateData(${index}, 'end', this.value)">
                    <input type="text" class="text-input" value="${sub.text.replace(/<br>/g, ' ')}" onchange="updateData(${index}, 'text', this.value)">
                    <button class="btn-icon" style="color:red" onclick="deleteLine(${index})">‚úñ</button>
                `;
                container.appendChild(row);
            });
        }

        function updateData(index, field, value) {
            if (field === 'text') {
                subtitleData[index].text = value; 
            } else {
                subtitleData[index][field] = timeToSec(value);
            }
            if(field === 'start') {
                subtitleData.sort((a,b) => a.start - b.start);
                renderEditor();
            }
        }

        function addSubtitleLine() {
            const ct = player ? player.getCurrentTime() : 0;
            subtitleData.push({ start: ct, end: ct + 3, text: "New Subtitle" });
            subtitleData.sort((a,b) => a.start - b.start);
            renderEditor();
        }

        function deleteLine(index) {
            if(confirm("Delete line?")) {
                subtitleData.splice(index, 1);
                renderEditor();
            }
        }

        function seekTo(sec) { if(player) player.seekTo(sec, true); }

        // --- PREVIEW ---
        function updatePreview() {
            const s = document.getElementById('subtitle');
            
            s.style.color = document.getElementById('subColor').value;
            const rgb = hexToRgb(document.getElementById('subBoxColor').value);
            s.style.backgroundColor = `rgba(${rgb.r},${rgb.g},${rgb.b},${document.getElementById('subBoxOp').value/100})`;
            
            const shadowVal = document.getElementById('subShadow').value;
            const shadowCol = document.getElementById('subShadowColor').value;
            s.style.textShadow = shadowVal == 0 ? 'none' : `${shadowVal}px ${shadowVal}px ${shadowVal}px ${shadowCol}`;
            
            const size = document.getElementById('subSize').value;
            s.style.fontSize = (32 * (size/100)) + "px";
            
            const anchor = document.getElementById('subAnchor').value;
            const offset = document.getElementById('subOffset').value;
            s.style.top = 'auto'; s.style.bottom = 'auto';
            if(anchor === 'top') s.style.top = offset + "%"; else s.style.bottom = offset + "%";

            const m = document.getElementById('preview-mask');
            m.style.height = document.getElementById('mHeight').value + "%";
            m.style.width = document.getElementById('mWidth').value + "%";
            m.style.bottom = document.getElementById('mBottom').value + "%";
            m.style.left = document.getElementById('mLeft').value + "%";
            m.style.backgroundColor = document.getElementById('mColor').value;
            m.style.opacity = document.getElementById('mOpacity').value / 100;
        }

        // --- FILE I/O ---
        function loadLocalJson(input) {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    populateUI(data);
                } catch(err) { alert("Invalid JSON"); }
            };
            r.readAsText(file);
        }

        function populateUI(data) {
            if(data.video) {
                document.getElementById('videoUrl').value = data.video;
                loadVideo(data.video);
            }
            if(data.subtitle) { parseSRTtoData(data.subtitle); renderEditor(); }
            else if (data.hiddenSub) { 
                let txt = decodeURIComponent(escape(atob(atob(data.hiddenSub).split('').reverse().join(''))));
                parseSRTtoData(txt); renderEditor();
            }

            if(data.mask) {
                document.getElementById('mHeight').value = data.mask.h;
                document.getElementById('mWidth').value = data.mask.w;
                document.getElementById('mBottom').value = data.mask.b;
                document.getElementById('mLeft').value = data.mask.l;
                if(data.mask.c) document.getElementById('mColor').value = data.mask.c;
                if(data.mask.o) document.getElementById('mOpacity').value = data.mask.o * 100;
            }
            
            if(data.settings) {
                document.getElementById('subAnchor').value = data.settings.anchor;
                document.getElementById('subOffset').value = data.settings.offset;
                document.getElementById('subSize').value = data.settings.scale * 100;
                if(data.settings.color) document.getElementById('subColor').value = data.settings.color;
                if(data.settings.boxColor) document.getElementById('subBoxColor').value = data.settings.boxColor;
                if(data.settings.boxOp) document.getElementById('subBoxOp').value = data.settings.boxOp * 100;
                if(data.settings.shadow) document.getElementById('subShadow').value = data.settings.shadow;
                if(data.settings.shadowColor) document.getElementById('subShadowColor').value = data.settings.shadowColor;
            }
            updatePreview();
        }

        function buildJson() {
            let srtOutput = "";
            subtitleData.forEach((s, i) => {
                srtOutput += `${i+1}\n${secToTime(s.start)} --> ${secToTime(s.end)}\n${s.text.replace(/-/g, '‚Äë')}\n\n`;
            });

            return JSON.stringify({
                video: document.getElementById('videoUrl').value,
                subtitle: srtOutput,
                mask: {
                    h: document.getElementById('mHeight').value,
                    w: document.getElementById('mWidth').value,
                    b: document.getElementById('mBottom').value,
                    l: document.getElementById('mLeft').value,
                    c: document.getElementById('mColor').value,
                    o: document.getElementById('mOpacity').value / 100
                },
                settings: {
                    anchor: document.getElementById('subAnchor').value,
                    offset: document.getElementById('subOffset').value,
                    scale: document.getElementById('subSize').value / 100,
                    color: document.getElementById('subColor').value,
                    boxColor: document.getElementById('subBoxColor').value,
                    boxOp: document.getElementById('subBoxOp').value / 100,
                    shadow: document.getElementById('subShadow').value,
                    shadowColor: document.getElementById('subShadowColor').value
                }
            }, null, 2);
        }

        function downloadJson() {
            const json = buildJson();
            const id = prompt("Filename ID:"); if(!id) return;
            const blob = new Blob([json], {type: "application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = id + ".json";
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

    async function uploadToGithub() {
            // ... (Your existing variable setup) ...
            
            // 1. THIS PART IS CORRECT (API PATH)
            // Do NOT change this to ../data
            const url = `https://api.github.com/repos/${user}/${repo}/contents/data/${id}.json`;

            try {
                // ... (Your existing check/upload logic) ...

                // IF UPLOAD IS SUCCESSFUL:
                if (uploadReq.ok) {
                    document.getElementById('result-area').style.display = 'block';
                    
                    // 2. THIS PART NEEDS THE FIX (SHARE LINK)
                    // We are in /admin/editor.html, but we want the link to be /cinema.html (Root)
                    
                    let loc = window.location.pathname; 
                    // Remove '/admin' from the end of the path
                    let dir = loc.substring(0, loc.lastIndexOf('/admin')); 
                    
                    // Final Link: https://user.github.io/repo/cinema.html?id=...
                    document.getElementById('finalLink').value = `${window.location.origin}${dir}/cinema.html?id=${id}`;
                    
                    alert("Success! File uploaded.");
                } else {
                    // ... error handling ...
                }

            } catch (error) { 
                // ... error handling ... 
            }
        }

        // --- HELPERS ---
        function parseSRTtoData(srt) {
            subtitleData = [];
            srt.trim().split(/\n\s*\n/).forEach(block => {
                const lines = block.split('\n');
                if (lines.length >= 3) {
                    const m = lines[1].match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
                    if (m) subtitleData.push({ start: timeToSec(m[1]), end: timeToSec(m[2]), text: lines.slice(2).join('<br>') });
                }
            });
        }
        function timeToSec(t) { const [h, m, s] = t.replace(',', '.').split(':'); return parseInt(h)*3600 + parseInt(m)*60 + parseFloat(s); }
        function secToTime(sec) {
            const date = new Date(sec * 1000);
            return date.toISOString().substr(11, 8) + "," + (sec % 1).toFixed(3).substring(2);
        }
        function saveGh() {
            localStorage.setItem('gh_user', document.getElementById('ghUser').value);
            localStorage.setItem('gh_repo', document.getElementById('ghRepo').value);
            localStorage.setItem('gh_token', document.getElementById('ghToken').value);
            alert("Config Saved");
        }
        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }
    </script>
</body>
</html>
