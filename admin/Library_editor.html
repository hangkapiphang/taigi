<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Diagnostic Tool</title>
    <style>
        body { font-family: sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; background: #1e1e1e; color: white; }
        
        /* DIAGNOSTIC PANEL */
        .diag-box { background: #333; padding: 20px; border-radius: 8px; border: 1px solid #555; margin-bottom: 20px; }
        .step { margin: 10px 0; padding: 10px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .step-label { font-weight: bold; }
        .status-wait { color: #aaa; }
        .status-ok { color: #4caf50; font-weight: bold; }
        .status-err { color: #ff5252; font-weight: bold; }
        
        /* ACTION BUTTONS */
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; font-size: 14px; width: 100%; margin-top: 10px; }
        .btn-fix { background: #ff9800; display: none; } /* Hidden by default */
        .btn-reset { background: #ff5252; margin-top: 20px;}
        
        /* EDITOR (Hidden until success) */
        #editor-area { display: none; background: #eee; color: #333; padding: 20px; border-radius: 8px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input { padding: 8px; width: 100%; }
        .save-btn { background: #28a745; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>ðŸš‘ System Diagnostic</h1>
    
    <div class="diag-box">
        <div class="step">
            <span class="step-label">1. Checking Token & User...</span>
            <span id="s1" class="status-wait">Waiting...</span>
        </div>
        <div class="step">
            <span class="step-label">2. Finding Repository...</span>
            <span id="s2" class="status-wait">Waiting...</span>
        </div>
        <div class="step">
            <span class="step-label">3. Checking 'gh-pages' Branch...</span>
            <span id="s3" class="status-wait">Waiting...</span>
        </div>
        
        <!-- ERROR MESSAGE AREA -->
        <div id="error-msg" style="color: #ff5252; padding: 10px; display:none;"></div>

        <!-- FIX BUTTONS -->
        <button id="btn-create-branch" class="btn btn-fix" onclick="createBranch()">ðŸ›  Branch Missing! Click to Create 'gh-pages'</button>
        <button id="btn-reset" class="btn btn-reset" onclick="resetCreds()">ðŸ”„ Reset Credentials (Start Over)</button>
    </div>

    <!-- SUCCESS EDITOR -->
    <div id="editor-area">
        <h2 style="margin-top:0;">âœ… Connection Successful!</h2>
        <p>You can now add items to your library.</p>
        <div id="list"></div>
        <button class="btn btn-fix" style="display:block; background:#2196F3;" onclick="addItem()">+ Add Movie</button>
        <button class="btn save-btn" onclick="saveData()">ðŸ’¾ Save to GitHub</button>
    </div>

    <script>
        const creds = {
            user: localStorage.getItem('gh_user'),
            repo: localStorage.getItem('gh_repo'),
            token: localStorage.getItem('gh_token')
        };
        
        let libraryData = [];
        let currentSHA = null;

        // START DIAGNOSIS AUTOMATICALLY
        window.onload = async function() {
            if(!creds.user || !creds.repo || !creds.token) {
                setStatus('s1', 'MISSING', false);
                showError("No credentials found. Please click 'Reset Credentials' to go back to Generator.");
                return;
            }
            
            // STEP 1: CHECK USER/TOKEN
            try {
                const uReq = await fetch('https://api.github.com/user', { headers: { Authorization: `token ${creds.token}` }});
                if(!uReq.ok) throw new Error("Invalid Token (401)");
                setStatus('s1', 'OK', true);
            } catch(e) {
                setStatus('s1', 'FAILED', false);
                showError("Your Token is invalid. Click Reset.");
                return;
            }

            // STEP 2: CHECK REPO
            try {
                // Encode to handle spaces in names
                const url = `https://api.github.com/repos/${encodeURIComponent(creds.user)}/${encodeURIComponent(creds.repo)}`;
                const rReq = await fetch(url, { headers: { Authorization: `token ${creds.token}` }});
                
                if(rReq.status === 404) throw new Error("Repo not found (404)");
                if(!rReq.ok) throw new Error("Repo Error");
                
                setStatus('s2', 'OK', true);
            } catch(e) {
                setStatus('s2', 'NOT FOUND', false);
                showError(`Could not find repository: ${creds.user}/${creds.repo}. \nDid you spell it correctly? Is it Private?`);
                return;
            }

            // STEP 3: CHECK BRANCH
            try {
                const bUrl = `https://api.github.com/repos/${encodeURIComponent(creds.user)}/${encodeURIComponent(creds.repo)}/branches/gh-pages`;
                const bReq = await fetch(bUrl, { headers: { Authorization: `token ${creds.token}` }});
                
                if(bReq.status === 404) {
                    setStatus('s3', 'MISSING', false);
                    document.getElementById('btn-create-branch').style.display = 'block';
                    return;
                }
                
                setStatus('s3', 'OK', true);
                loadEditor();

            } catch(e) {
                setStatus('s3', 'ERROR', false);
                showError("Network error checking branch.");
            }
        };

        // --- UTILS ---
        function setStatus(id, text, isGood) {
            const el = document.getElementById(id);
            el.innerText = text;
            el.className = isGood ? 'status-ok' : 'status-err';
        }
        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.style.display = 'block';
            el.innerText = "ERROR: " + msg;
        }
        function resetCreds() {
            localStorage.clear();
            window.location.href = "generator.html";
        }

        // --- FIXER FUNCTION ---
        async function createBranch() {
            const btn = document.getElementById('btn-create-branch');
            btn.innerText = "Creating...";
            
            try {
                // Get Main SHA
                const mainReq = await fetch(`https://api.github.com/repos/${creds.user}/${creds.repo}/git/ref/heads/main`, {
                    headers: { Authorization: `token ${creds.token}` }
                });
                const mainData = await mainReq.json();
                
                // Create Branch
                const createReq = await fetch(`https://api.github.com/repos/${creds.user}/${creds.repo}/git/refs`, {
                    method: 'POST',
                    headers: { Authorization: `token ${creds.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ref: 'refs/heads/gh-pages', sha: mainData.object.sha })
                });

                if(createReq.ok) {
                    alert("Branch Created! Reloading...");
                    window.location.reload();
                } else {
                    alert("Failed to create. Do you have a 'main' branch?");
                }
            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        // --- EDITOR LOGIC ---
        async function loadEditor() {
            document.getElementById('editor-area').style.display = 'block';
            const url = `https://api.github.com/repos/${creds.user}/${creds.repo}/contents/data/library.json?ref=gh-pages`;
            try {
                const req = await fetch(url, { headers: { Authorization: `token ${creds.token}`, 'Cache-Control': 'no-cache' }});
                if(req.ok) {
                    const data = await req.json();
                    currentSHA = data.sha;
                    libraryData = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                    renderList();
                } else {
                    libraryData = []; // New file
                }
            } catch(e) { libraryData = []; }
        }

        function renderList() {
            const list = document.getElementById('list');
            list.innerHTML = "";
            libraryData.forEach((item, i) => {
                list.innerHTML += `<div class="input-row"><input value="${item.title}" onchange="libraryData[${i}].title=this.value"> <button onclick="libraryData.splice(${i},1);renderList()">X</button></div>`;
            });
        }
        function addItem() { libraryData.push({id:"new",title:"New Video",yt:"",cat:"cartoon",desc:""}); renderList(); }

        async function saveData() {
            // Get SHA again just in case
            try {
                 const c = await fetch(`https://api.github.com/repos/${creds.user}/${creds.repo}/contents/data/library.json?ref=gh-pages`, { headers: { Authorization: `token ${creds.token}` }});
                 if(c.ok) currentSHA = (await c.json()).sha;
            } catch(e){}

            const body = {
                message: "Update",
                content: btoa(unescape(encodeURIComponent(JSON.stringify(libraryData, null, 2)))),
                branch: "gh-pages"
            };
            if(currentSHA) body.sha = currentSHA;

            await fetch(`https://api.github.com/repos/${creds.user}/${creds.repo}/contents/data/library.json`, {
                method: 'PUT',
                headers: { Authorization: `token ${creds.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            alert("Saved!");
        }
    </script>
</body>
</html>