<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Editor - Vocabulary</title>
    <script>
        if (localStorage.getItem('is_admin') !== 'true') {
            if (prompt("Enter Admin Password:") === "1234") localStorage.setItem('is_admin', 'true');
            else { alert("Access Denied"); window.location.href = "../index.html"; }
        }
    </script>
    <style>
        @font-face { font-family: 'Taigi Font'; src: url('../font/Charis-Regular.woff2') format('woff2'); }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #fff8e1; height: 100vh; display: flex; flex-direction: column; }
        
        nav { background: #2c3e50; padding: 10px; display: flex; gap: 10px; flex-shrink: 0; overflow-x: auto; white-space: nowrap; }
        nav a { color: #ccc; text-decoration: none; padding: 8px 12px; border-radius: 4px; font-size: 14px; }
        nav a.active { background: #ff9800; color: black; font-weight: bold; }

        #workspace { display: flex; flex-grow: 1; overflow: hidden; height: 100%; }

        /* LEFT PANEL (Video) */
        #left-panel { width: 40%; background: #000; display: flex; flex-direction: column; border-right: 1px solid #ccc; z-index: 10; }
        #video-container { width: 100%; aspect-ratio: 16/9; flex-shrink: 0; }
        #player { width: 100%; height: 100%; }
        
        #global-controls { padding: 10px; background: #fffcf5; overflow-y: auto; flex-grow: 1; }
        .control-group { margin-bottom: 10px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; }
        
        /* RIGHT PANEL (Editor) */
        #right-panel { width: 60%; background: #fdfdfd; display: flex; flex-direction: column; }
        #toolbar { padding: 10px; background: #fff; border-bottom: 1px solid #ddd; display: flex; gap: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        #rows-area { flex-grow: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }

        /* CARDS */
        .vocab-card { 
            display: flex; flex-direction: column; background: white; border: 1px solid #ddd; 
            border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .v-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        
        /* Layout for inputs: Row on PC, Column on Mobile */
        .v-inputs { display: flex; gap: 10px; }
        
        .time-inp { width: 60px; text-align: center; border: 1px solid #ccc; border-radius: 3px; padding: 5px; font-weight: bold; color: #555; font-size: 14px; }
        .word-inp { flex: 1; font-family: 'Taigi Font'; font-size: 18px; font-weight: bold; padding: 8px; border: 1px solid #eee; background: #fafafa; border-radius: 4px; }
        .def-inp { flex: 2; font-family: 'Taigi Font'; font-size: 16px; padding: 8px; border: 1px solid #eee; border-radius: 4px; }

        .btn { padding: 8px 12px; border: none; border-radius: 4px; font-weight: bold; color: white; cursor: pointer; font-size: 14px; }
        .btn-full { width: 100%; margin-top: 5px; padding: 8px; }
        .btn-icon { background: none; border: none; font-size: 20px; padding: 0 10px; cursor: pointer; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            #workspace { flex-direction: column; }
            
            #left-panel { width: 100%; height: auto; max-height: 40vh; flex-shrink: 0; }
            #video-container { width: 100%; }
            
            #global-controls { display: none; } /* Hide config by default */
            #global-controls.show { display: block; height: 180px; }

            #right-panel { width: 100%; height: auto; flex-grow: 1; }
            
            /* Stack Inputs on Mobile */
            .v-inputs { flex-direction: column; gap: 5px; }
            .word-inp, .def-inp { width: 100%; font-size: 16px; /* prevent zoom */ }
        }
    </style>
</head>
<body>
    <nav>
        <a href="subtitle_editor.html">üìù Subtitles</a>
        <a href="vocab_editor.html" class="active">üìñ Vocabulary</a>
        <a href="visual_editor.html">üé® Visuals</a>
        <button onclick="toggleSettings()" style="margin-left:auto; background:#444; color:fff; border:none; padding:5px 10px; border-radius:4px; font-size:12px;">‚öôÔ∏è Config</button>
    </nav>

    <div id="workspace">
        <div id="left-panel">
            <div id="video-container"><div id="player"></div></div>
            <div id="global-controls">
                <div class="control-group">
                    <strong>Video</strong>
                    <input type="text" id="videoUrl" style="width:100%; padding:8px; margin-top:5px;" placeholder="YouTube URL" onchange="loadVideo(this.value)">
                </div>
                <div class="control-group">
                    <button class="btn" style="background:#17a2b8; flex:1" onclick="document.getElementById('hidden-file').click()">üìÇ Open</button>
                    <input type="file" id="hidden-file" accept=".json" style="display:none" onchange="loadLocalJson(this)">
                    <button class="btn" style="background:#28a745; flex:1" onclick="downloadJson()">üíæ Save</button>
                </div>
                <div class="control-group">
                    <strong>GitHub</strong>
                    <input type="text" id="ghUser" placeholder="User" style="width:40%; padding:5px;">
                    <input type="text" id="ghRepo" placeholder="Repo" style="width:40%; padding:5px;">
                    <input type="password" id="ghToken" placeholder="Token" style="width:100%; padding:5px; margin-top:5px;">
                    <button class="btn btn-full" style="background:#333;" onclick="uploadToGithub()">‚òÅ Upload</button>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div id="toolbar">
                <button class="btn" style="background:#9c27b0; flex:1" onclick="addVocabLine()">+ Add Word</button>
                <button class="btn" style="background:#ffeb3b; color:black; flex:1" onclick="importAiVocab()">‚ö° Import AI</button>
            </div>
            <div id="rows-area"></div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player, vocabData = [];
        let globalData = { subtitle: "", mask: {}, settings: {} };

        function toggleSettings() {
            const el = document.getElementById('global-controls');
            el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
        }

        window.onload = function() {
            ['ghUser', 'ghRepo', 'ghToken'].forEach(k => { if(localStorage.getItem(k)) document.getElementById(k).value = localStorage.getItem(k); });
            if(window.innerWidth < 768) document.getElementById('global-controls').style.display = 'none';
        }
        function onYouTubeIframeAPIReady() {}
        function loadVideo(url) {
            const id = (url.match(/[?&]v=([^&#]*)/) || url.match(/youtu\.be\/([^?&#]+)/))?.[1];
            if(!id) return;
            globalData.video = url;
            if(player) player.loadVideoById(id);
            else player = new YT.Player('player', { videoId: id });
        }

        function renderEditor() {
            const c = document.getElementById('rows-area'); c.innerHTML = '';
            vocabData.forEach((v, i) => {
                c.innerHTML += `
                    <div class="vocab-card">
                        <div class="v-header">
                            <div>
                                <button class="btn-icon" style="color:green" onclick="player.seekTo(${v.time}, true)">‚ñ∂</button>
                                <input type="number" class="time-inp" value="${v.time.toFixed(1)}" onchange="updateVocab(${i}, 'time', this.value)"> s
                            </div>
                            <button class="btn-icon" style="color:red" onclick="deleteVocab(${i})">‚úñ</button>
                        </div>
                        <div class="v-inputs">
                            <input type="text" class="word-inp" placeholder="Word/POJ" value="${v.word}" onchange="updateVocab(${i}, 'word', this.value)">
                            <input type="text" class="def-inp" placeholder="Definition" value="${v.def}" onchange="updateVocab(${i}, 'def', this.value)">
                        </div>
                    </div>`;
            });
        }

        function updateVocab(i, f, v) {
            vocabData[i][f] = f === 'time' ? parseFloat(v) : v;
            if(f === 'time') { vocabData.sort((a,b)=>a.time-b.time); renderEditor(); }
        }
        function addVocabLine() {
            const t = player ? player.getCurrentTime() : 0;
            vocabData.push({time:t, word:"", def:""});
            vocabData.sort((a,b)=>a.time-b.time); renderEditor();
        }
        function deleteVocab(i) { if(confirm("Delete?")) { vocabData.splice(i,1); renderEditor(); } }
        function importAiVocab() {
            const str = prompt("Paste AI JSON Array:");
            try {
                const arr = JSON.parse(str);
                if(Array.isArray(arr)) { vocabData = vocabData.concat(arr); vocabData.sort((a,b)=>a.time-b.time); renderEditor(); }
            } catch(e){ alert("Invalid JSON"); }
        }

        function loadLocalJson(input) {
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    globalData = d; 
                    if(d.video) { document.getElementById('videoUrl').value = d.video; loadVideo(d.video); }
                    if(d.vocab) vocabData = d.vocab;
                    renderEditor();
                } catch(e) { alert("Error parsing"); }
            };
            r.readAsText(input.files[0]);
        }
        function buildJson() {
            globalData.vocab = vocabData;
            globalData.video = document.getElementById('videoUrl').value;
            return JSON.stringify(globalData, null, 2);
        }
        function downloadJson() {
            const b = new Blob([buildJson()], {type:"application/json"});
            const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="cinema_vocab.json"; a.click();
        }
        function uploadToGithub() {
            const u=document.getElementById('ghUser').value, r=document.getElementById('ghRepo').value, t=document.getElementById('ghToken').value;
            localStorage.setItem('ghUser', u); localStorage.setItem('ghRepo', r); localStorage.setItem('ghToken', t);
            const id = prompt("Filename ID:"); if(!id) return;
            const url = `https://api.github.com/repos/${u}/${r}/contents/data/${id}.json`;
            const content = btoa(unescape(encodeURIComponent(buildJson())));
            fetch(url+"?ref=gh-pages",{headers:{'Authorization':`token ${t}`}}).then(res=>{
                res.json().then(d => {
                    fetch(url, {method:'PUT', headers:{'Authorization':`token ${t}`}, body:JSON.stringify({message:"Upd Vocab", content:content, branch:"gh-pages", sha:d.sha})}).then(x=>alert(x.ok?"Saved!":"Error"));
                });
            });
        }
    </script>
</body>
</html>