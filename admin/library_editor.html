<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Editor (gh-pages)</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f4f4f4; }
        
        /* Header & Status */
        .header { display: flex; justify-content: space-between; align-items: center; background: #333; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .status { font-family: monospace; font-weight: bold; color: #4caf50; }
        .error { color: #ff5555; }

        /* Movie Cards */
        #list-area { display: flex; flex-direction: column; gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 6px; display: flex; gap: 15px; align-items: flex-start; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Thumbnails */
        .thumb { width: 120px; height: 68px; background: #ddd; object-fit: cover; border-radius: 4px; }
        
        /* Inputs */
        .inputs { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }

        /* Buttons */
        .toolbar { margin-top: 20px; padding-top: 20px; border-top: 2px solid #ccc; display: flex; gap: 10px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; color: white; font-size: 14px; }
        .btn-add { background: #28a745; }
        .btn-save { background: #007bff; }
        .btn-del { background: #dc3545; padding: 5px 10px; font-size: 12px; height: fit-content; }
        
        /* Loading Overlay */
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; z-index:999; font-size: 20px; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="overlay">Connecting to 'gh-pages'...</div>

    <div class="header">
        <div>üìÇ <b>Branch:</b> gh-pages</div>
        <div id="status" class="status">Connecting...</div>
    </div>

    <div id="list-area"></div>

    <div class="toolbar">
        <button class="btn-add" onclick="addItem()">+ Add Movie</button>
        <div style="flex-grow:1;"></div>
        <button class="btn-save" onclick="saveToGitHub()">üíæ Save to GitHub</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const BRANCH = "gh-pages";
        const FILE_PATH = "../data/library.json";
        
        let libraryData = [];
        let currentSHA = null;
        let user, repo, token;

        // --- 1. INITIALIZE ---
        window.onload = function() {
            user = localStorage.getItem('gh_user');
            repo = localStorage.getItem('gh_repo');
            token = localStorage.getItem('gh_token');

            if(!user || !repo || !token) {
                alert("Credentials missing!");
                window.location.href = "generator.html";
                return;
            }

            loadData();
        };

        function setStatus(msg, isError=false) {
            const el = document.getElementById('status');
            el.innerText = msg;
            el.className = isError ? "status error" : "status";
            console.log(msg);
        }

        // --- 2. LOAD DATA ---
        async function loadData() {
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${FILE_PATH}?ref=${BRANCH}&t=${Date.now()}`;
            
            try {
                const req = await fetch(url, { headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' } });
                
                // CASE 1: File doesn't exist yet (404)
                if(req.status === 404) {
                    setStatus("File not found. Starting Fresh.");
                    libraryData = [];
                    currentSHA = null;
                    document.getElementById('overlay').classList.add('hidden');
                    render();
                    return;
                }

                // CASE 2: Error
                if(!req.ok) throw new Error(req.statusText);

                // CASE 3: Success
                const data = await req.json();
                currentSHA = data.sha;
                libraryData = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                
                setStatus(`Loaded ${libraryData.length} items.`);
                document.getElementById('overlay').classList.add('hidden');
                render();

            } catch(e) {
                setStatus("Load Error: " + e.message, true);
                document.getElementById('overlay').innerText = "Error: " + e.message;
            }
        }

        // --- 3. RENDER UI ---
        function render() {
            const container = document.getElementById('list-area');
            container.innerHTML = "";

            if(libraryData.length === 0) {
                container.innerHTML = "<div style='text-align:center; padding:30px; color:#777;'>Library is empty. Click <b>+ Add Movie</b>.</div>";
                return;
            }

            libraryData.forEach((item, i) => {
                container.innerHTML += `
                    <div class="card">
                        <img src="https://img.youtube.com/vi/${item.yt}/default.jpg" class="thumb" onerror="this.src='https://via.placeholder.com/120?text=No+Img'">
                        <div class="inputs">
                            <input type="text" placeholder="Title" value="${item.title}" onchange="update(${i}, 'title', this.value)">
                            <input type="text" placeholder="YouTube ID" value="${item.yt}" onchange="update(${i}, 'yt', this.value)">
                            <input type="text" placeholder="ID (e.g. frozen)" value="${item.id}" onchange="update(${i}, 'id', this.value)">
                            <select onchange="update(${i}, 'cat', this.value)">
                                <option value="cartoon" ${item.cat==='cartoon'?'selected':''}>Cartoon</option>
                                <option value="song" ${item.cat==='song'?'selected':''}>Song</option>
                                <option value="speech" ${item.cat==='speech'?'selected':''}>Speech</option>
                                <option value="drama" ${item.cat==='drama'?'selected':''}>Drama</option>
                            </select>
                            <input type="text" class="full" placeholder="Description" value="${item.desc}" onchange="update(${i}, 'desc', this.value)">
                        </div>
                        <button class="btn-del" onclick="remove(${i})">X</button>
                    </div>
                `;
            });
        }

        // --- 4. ACTIONS ---
        function update(i, key, val) { 
            libraryData[i][key] = val; 
            if(key === 'yt') render(); // Refresh thumb
        }
        
        function addItem() {
            libraryData.push({ id: "new", title: "New Video", yt: "", cat: "cartoon", desc: "", date: new Date().toISOString().slice(0,10) });
            render();
        }

        function remove(i) {
            if(confirm("Delete this item?")) {
                libraryData.splice(i, 1);
                render();
            }
        }

        // --- 5. SAVE ---
        async function saveToGitHub() {
            if(!confirm(`Save changes to '${BRANCH}' branch?`)) return;
            setStatus("Saving...", false);

            // Double check SHA (Safety Step)
            try {
                const check = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${FILE_PATH}?ref=${BRANCH}`, 
                    { headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' } });
                if(check.ok) currentSHA = (await check.json()).sha;
                else currentSHA = null;
            } catch(e) {}

            const body = {
                message: "Update Library",
                content: btoa(unescape(encodeURIComponent(JSON.stringify(libraryData, null, 2)))),
                branch: BRANCH
            };
            if(currentSHA) body.sha = currentSHA;

            try {
                const req = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if(!req.ok) {
                    const err = await req.json();
                    throw new Error(err.message);
                }

                const res = await req.json();
                currentSHA = res.content.sha;
                setStatus("‚úÖ Saved Successfully!");
                alert("Saved! Changes will appear in ~1 minute.");

            } catch(e) {
                setStatus("‚ùå Save Failed: " + e.message, true);
                alert("Save Failed:\n" + e.message);
            }
        }
    </script>
</body>
</html>
