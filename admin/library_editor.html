<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Editor - Branch Selector</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f4f4f4; }
        
        /* Debug Console */
        .console { background: #222; color: #0f0; padding: 15px; font-family: monospace; height: 120px; overflow-y: scroll; border-radius: 5px; margin-bottom: 20px; border: 2px solid #555; }
        .log-err { color: #ff5555; }
        .log-succ { color: #55ff55; }
        .log-info { color: #aaa; }

        /* UI */
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; background: #ddd; padding: 10px; border-radius: 5px; }
        .branch-group { display: flex; flex-direction: column; }
        .branch-group label { font-size: 0.8rem; font-weight: bold; color: #555; }
        
        input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
        .btn-green { background: #28a745; }
        .btn-blue { background: #007bff; }
        .btn-red { background: #dc3545; }

        /* List Items */
        .row { background: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; gap: 10px; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .thumb { width: 80px; height: 45px; object-fit: cover; background: #eee; }
        .inputs { display: flex; flex-direction: column; gap: 5px; flex-grow: 1; }
        .inputs input { width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <h1>üé¨ Library Editor</h1>
    
    <!-- DEBUG CONSOLE -->
    <div id="console" class="console">Ready.</div>

    <!-- CONTROLS -->
    <div class="toolbar">
        <div class="branch-group">
            <label>Target Branch:</label>
            <!-- DEFAULTED TO GH-PAGES -->
            <input type="text" id="branch-input" value="gh-pages" style="width: 100px; text-align:center; font-weight:bold;">
        </div>
        <button onclick="loadFromGitHub()" class="btn-blue">üîÑ Connect & Load</button>
        <div style="flex-grow:1;"></div>
        <button onclick="addItem()" class="btn-green">+ Add Movie</button>
        <button onclick="saveToGitHub()" class="btn-green">üíæ Save Changes</button>
    </div>

    <!-- MOVIE LIST -->
    <div id="list-area"></div>

    <script>
        let libraryData = [];
        let currentSHA = null;

        // --- LOGGER ---
        function log(msg, type="") {
            const c = document.getElementById('console');
            const colorClass = type === 'err' ? 'log-err' : (type === 'succ' ? 'log-succ' : 'log-info');
            c.innerHTML += `<div class="${colorClass}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        // --- 1. CONNECT & LOAD ---
        async function loadFromGitHub() {
            const user = localStorage.getItem('gh_user');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const branch = document.getElementById('branch-input').value; // READS FROM INPUT

            if(!user || !repo || !token) {
                log("‚ùå Credentials missing. Go to Generator page.", "err");
                return;
            }

            log(`üîç Connecting to ${user}/${repo} [Branch: ${branch}]...`);

            // Add timestamp to force fresh check
            const timestamp = new Date().getTime();
            const fileUrl = `https://api.github.com/repos/${user}/${repo}/contents/data/library.json?ref=${branch}&_t=${timestamp}`;
            
            try {
                const fileReq = await fetch(fileUrl, { 
                    headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' } 
                });
                
                if(fileReq.status === 404) {
                    log(`‚ö†Ô∏è 'data/library.json' not found on branch '${branch}'.`, "err");
                    log("üí° Starting with a NEW empty list. (Will create file on Save)", "succ");
                    libraryData = [];
                    currentSHA = null;
                } else if(fileReq.status === 401 || fileReq.status === 403) {
                    log("‚ùå Access Denied. Check your Token.", "err");
                    return;
                } else {
                    const fileData = await fileReq.json();
                    currentSHA = fileData.sha;
                    const jsonString = decodeURIComponent(escape(atob(fileData.content)));
                    libraryData = JSON.parse(jsonString);
                    log(`‚úÖ Loaded ${libraryData.length} movies from '${branch}'!`, "succ");
                }
                renderList();

            } catch(e) {
                log(`‚ùå Connection Error: ${e.message}`, "err");
            }
        }

        // --- 2. RENDER UI ---
        function renderList() {
            const container = document.getElementById('list-area');
            container.innerHTML = "";
            
            if(libraryData.length === 0) {
                container.innerHTML = "<div style='padding:20px; text-align:center; background:white;'>Library is empty. Click <b>+ Add Movie</b> to start.</div>";
                return;
            }

            libraryData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'row';
                div.innerHTML = `
                    <img src="https://img.youtube.com/vi/${item.yt}/default.jpg" class="thumb" onerror="this.src='https://via.placeholder.com/80?text=?'">
                    <div class="inputs">
                        <input type="text" placeholder="Title" value="${item.title}" onchange="update(${index}, 'title', this.value)" style="font-weight:bold;">
                        <input type="text" placeholder="YouTube ID" value="${item.yt}" onchange="update(${index}, 'yt', this.value)">
                        <input type="text" placeholder="ID (e.g. frozen)" value="${item.id}" onchange="update(${index}, 'id', this.value)">
                    </div>
                    <button class="btn-red" onclick="del(${index})">X</button>
                `;
                container.appendChild(div);
            });
        }

        function update(i, key, val) { libraryData[i][key] = val; renderList(); }
        function addItem() { 
            libraryData.push({id: "new", title: "New Movie", yt: "", cat: "cartoon", desc: "", date: ""}); 
            renderList(); 
        }
        function del(i) { libraryData.splice(i,1); renderList(); }

        // --- 3. SAVE ---
        async function saveToGitHub() {
            const user = localStorage.getItem('gh_user');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const branch = document.getElementById('branch-input').value; // READS FROM INPUT
            
            log(`üíæ Saving to branch: ${branch}...`, "info");

            // STEP 1: Check if file exists to get SHA (Double Check)
            try {
                 const checkReq = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/data/library.json?ref=${branch}`, {
                     headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' }
                 });
                 if(checkReq.ok) {
                     const d = await checkReq.json();
                     currentSHA = d.sha;
                 } else {
                     currentSHA = null; // File doesn't exist, will create new
                 }
            } catch(e) { log("‚ö†Ô∏è Could not verify SHA, trying blindly...", "info"); }

            // STEP 2: Upload
            const url = `https://api.github.com/repos/${user}/${repo}/contents/data/library.json`;
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(libraryData, null, 2))));
            
            const body = {
                message: "Update Library",
                content: content,
                branch: branch
            };
            if(currentSHA) body.sha = currentSHA;

            try {
                const req = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if(!req.ok) {
                    const err = await req.json();
                    log(`‚ùå Save Failed: ${err.message}`, "err");
                } else {
                    const res = await req.json();
                    currentSHA = res.content.sha;
                    log("‚úÖ Saved Successfully!", "succ");
                    alert("Saved!");
                }
            } catch(e) {
                log(`‚ùå Network Error: ${e.message}`, "err");
            }
        }

        // Auto load on open
        window.onload = loadFromGitHub;
    </script>
</body>
</html>