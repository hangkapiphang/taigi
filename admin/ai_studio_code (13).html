<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Editor (Fixed)</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f4f4f4; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; }
        #status { font-weight: bold; color: #555; background: #e8e8e8; padding: 5px 10px; border-radius: 4px; }
        #list-area { display: flex; flex-direction: column; gap: 15px; }
        .row { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: flex-start; }
        .actions { display: flex; flex-direction: column; align-items: center; min-width: 120px; }
        .thumb-preview { width: 120px; height: 68px; object-fit: cover; border-radius: 4px; background: #ddd; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .form-group label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 2px; }
        input, select { width: 100%; padding: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .full-width { width: 100%; }
        .btn { cursor: pointer; padding: 5px 10px; border: none; border-radius: 4px; }
        .btn-move { background: #eee; }
        .btn-move:hover { background: #ddd; }
        .btn-del { background: #ffcccc; color: #cc0000; margin-top: auto; }
        .btn-del:hover { background: #ffaaaa; }
        .main-btn { padding: 10px 20px; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 5px; }
        .btn-add { background: #28a745; }
        .btn-save { background: #007bff; }
        .btn-add:hover { background: #218838; }
        .btn-save:hover { background: #0069d9; }
        .toolbar { margin-top: 30px; display: flex; gap: 10px; padding-bottom: 50px;}
    </style>
</head>
<body>

    <header>
        <h1>üé¨ Library Editor</h1>
        <div id="status">Initializing...</div>
    </header>

    <div id="list-area"></div>

    <div class="toolbar">
        <button class="main-btn btn-add" onclick="addItem()">+ Add New Movie</button>
        <button class="main-btn btn-save" onclick="saveToGitHub()">üíæ Save & Publish</button>
    </div>

    <script>
        let libraryData = [];
        let currentSHA = null; // Stores the file ID

        // --- 1. INITIAL LOAD ---
        window.onload = function() {
            const user = localStorage.getItem('gh_user');
            const token = localStorage.getItem('gh_token');
            
            if(!user || !token) {
                if(confirm("Credentials Missing! Go to Generator page?")) {
                    window.location.href = "generator.html";
                }
            } else {
                loadFromGitHub();
            }
        }

        // --- 2. GITHUB API: READ ---
        async function loadFromGitHub() {
            const user = localStorage.getItem('gh_user');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const status = document.getElementById('status');

            status.innerText = "Connecting...";
            console.log(`Attempting to load: https://api.github.com/repos/${user}/${repo}/contents/data/library.json?ref=gh-pages`);

            const url = `https://api.github.com/repos/${user}/${repo}/contents/data/library.json?ref=gh-pages`;

            try {
                const req = await fetch(url, { 
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Cache-Control': 'no-cache'
                    } 
                });
                
                if (req.status === 404) {
                    status.innerText = "File not found (New Setup).";
                    console.log("File returned 404. Assuming new file creation.");
                    libraryData = [];
                    currentSHA = null;
                    renderList();
                    return;
                }

                if (!req.ok) throw new Error(`Read Error: ${req.status} ${req.statusText}`);
                
                const data = await req.json();
                currentSHA = data.sha; // Save the SHA
                console.log("Initial SHA loaded:", currentSHA);
                
                const jsonString = decodeURIComponent(escape(atob(data.content)));
                libraryData = JSON.parse(jsonString);
                
                renderList();
                status.innerText = "‚úÖ Loaded";

            } catch (err) {
                console.error(err);
                status.innerText = "Error loading data.";
                alert("Failed to Load!\nCheck Console (F12) for details.\n\n" + err.message);
            }
        }

        // --- 3. RENDER UI ---
        function renderList() {
            const container = document.getElementById('list-area');
            container.innerHTML = "";

            if (libraryData.length === 0) {
                container.innerHTML = "<div style='text-align:center; padding:20px; color:#777; background:white;'>No movies in library yet. Click '+ Add New Movie'.</div>";
                return;
            }

            libraryData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'row';
                div.innerHTML = `
                    <div class="actions">
                        <img src="https://img.youtube.com/vi/${item.yt}/hqdefault.jpg" class="thumb-preview" id="thumb-${index}" onerror="this.src='https://via.placeholder.com/120x68?text=No+Img'">
                        <div style="display:flex; gap:5px; justify-content:center; margin-top:5px;">
                            <button class="btn btn-move" onclick="moveItem(${index}, -1)">‚ñ≤</button>
                            <button class="btn btn-move" onclick="moveItem(${index}, 1)">‚ñº</button>
                        </div>
                    </div>

                    <div style="flex-grow:1;">
                        <div class="input-grid">
                            <div class="form-group">
                                <label>JSON Filename (ID)</label>
                                <input type="text" value="${item.id || ''}" onchange="updateItem(${index}, 'id', this.value)">
                            </div>
                            <div class="form-group">
                                <label>YouTube ID</label>
                                <input type="text" value="${item.yt || ''}" onchange="updateItem(${index}, 'yt', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select onchange="updateItem(${index}, 'cat', this.value)">
                                    <option value="song" ${item.cat === 'song' ? 'selected' : ''}>üéµ Song</option>
                                    <option value="cartoon" ${item.cat === 'cartoon' ? 'selected' : ''}>üß∏ Cartoon</option>
                                    <option value="speech" ${item.cat === 'speech' ? 'selected' : ''}>üé§ Speech</option>
                                    <option value="drama" ${item.cat === 'drama' ? 'selected' : ''}>üé≠ Drama</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="full-width" value="${item.title || ''}" onchange="updateItem(${index}, 'title', this.value)">
                        </div>
                        
                        <div class="form-group" style="margin-top:10px;">
                            <label>Description</label>
                            <input type="text" class="full-width" value="${item.desc || ''}" onchange="updateItem(${index}, 'desc', this.value)">
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-del" onclick="deleteItem(${index})">Delete</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- 4. CRUD ACTIONS ---
        function updateItem(index, field, value) {
            libraryData[index][field] = value;
            if(field === 'yt') {
                const img = document.getElementById(`thumb-${index}`);
                if(value.length > 5) img.src = `https://img.youtube.com/vi/${value}/hqdefault.jpg`;
            }
        }

        function addItem() {
            libraryData.push({ id: "", title: "New Video", desc: "", cat: "cartoon", yt: "", date: new Date().toISOString().slice(0, 10) });
            renderList();
            setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
        }

        function deleteItem(index) {
            if(confirm("Remove this movie?")) {
                libraryData.splice(index, 1);
                renderList();
            }
        }

        function moveItem(index, direction) {
            if (index + direction < 0 || index + direction >= libraryData.length) return;
            const temp = libraryData[index];
            libraryData[index] = libraryData[index + direction];
            libraryData[index + direction] = temp;
            renderList();
        }

        // --- 5. GITHUB API: SAVE (ROBUST VERSION) ---
        async function saveToGitHub() {
            const user = localStorage.getItem('gh_user');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const status = document.getElementById('status');

            if (!confirm("Update live website?")) return;

            status.innerText = "Verifying file ID...";
            console.log("Starting Save Process...");

            // STEP 1: FORCE FETCH THE LATEST SHA
            // We do not rely on the cached SHA. We fetch it fresh.
            const checkUrl = `https://api.github.com/repos/${user}/${repo}/contents/data/library.json?ref=gh-pages`;
            let latestSHA = null;

            try {
                const checkReq = await fetch(checkUrl, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `token ${token}`, 
                        'Cache-Control': 'no-cache, no-store, must-revalidate' // aggressive no-cache
                    }
                });

                console.log(`SHA Check Status: ${checkReq.status}`);

                if (checkReq.ok) {
                    const checkData = await checkReq.json();
                    latestSHA = checkData.sha;
                    console.log("Found existing file SHA:", latestSHA);
                } else if (checkReq.status === 404) {
                    console.log("File not found on server (404). Will try to create new.");
                    latestSHA = null;
                } else {
                    // IF we get here (e.g., 403 Forbidden, 500 Error), WE STOP.
                    // Proceeding blindly causes the "Invalid request" error.
                    throw new Error(`Could not verify file status. GitHub API returned: ${checkReq.status}`);
                }
            } catch (err) {
                console.error("SHA Check Failed:", err);
                status.innerText = "‚ùå Connection Error";
                alert("Cannot connect to GitHub to verify file version.\nCheck console for details.\n\n" + err.message);
                return; // STOP EXECUTION
            }

            // STEP 2: PREPARE UPLOAD
            status.innerText = "Uploading...";
            
            const url = `https://api.github.com/repos/${user}/${repo}/contents/data/library.json`;
            const jsonString = JSON.stringify(libraryData, null, 2);
            const content = btoa(unescape(encodeURIComponent(jsonString)));

            const body = {
                message: "Update Library Menu via Editor",
                content: content,
                branch: "gh-pages"
            };

            // Attach SHA if we found it. 
            // If latestSHA is null, we send without SHA (Create mode).
            if (latestSHA) {
                body.sha = latestSHA;
            }

            // STEP 3: SEND PUT REQUEST
            try {
                const req = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                // Handle specific errors
                if (!req.ok) {
                    const err = await req.json();
                    
                    // Case: 422 "sha wasn't supplied" - The file exists but our Step 1 thought it didn't.
                    if (req.status === 422 && err.message.includes("sha")) {
                        alert("Sync Error: GitHub says the file exists, but we missed it.\n\nPlease Refresh the page and try again.");
                    } 
                    // Case: 409 "Conflict" - Someone else updated it while we were working.
                    else if (req.status === 409) {
                        alert("Conflict Error: The file was updated by someone else just now.\n\nPlease Refresh and try again.");
                    }
                    else {
                        throw new Error(`${req.status} - ${err.message}`);
                    }
                    return;
                }
                
                const res = await req.json();
                currentSHA = res.content.sha; // Update local SHA for next save
                status.innerText = "‚úÖ Saved!";
                alert("Success! The menu has been updated.");

            } catch (err) {
                console.error(err);
                status.innerText = "‚ùå Save Failed";
                alert("Save Failed:\n" + err.message);
            }
        }
    </script>
</body>
</html>