<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Editor - Subtitles</title>
    <script>
        // Admin Check
        if (localStorage.getItem('is_admin') !== 'true') {
            if (prompt("Enter Admin Password:") === "Taigibun") {
                localStorage.setItem('is_admin', 'true');
            } else { 
                alert("Access Denied"); 
                location.reload(); 
            }
        }
    </script>
    <style>
        /* Basic Styles */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        
        /* Font styles simulation */
        .taigi-font { font-family: 'Charis SIL', serif; }
        
        nav { background: #2c3e50; padding: 10px; display: flex; gap: 10px; flex-shrink: 0; overflow-x: auto; white-space: nowrap; }
        nav a { color: #ccc; text-decoration: none; padding: 8px 12px; border-radius: 4px; font-size: 14px; }
        nav a.active { background: #007bff; color: white; font-weight: bold; }

        #workspace { display: flex; flex-grow: 1; overflow: hidden; height: 100%; }
        
        #left-panel { width: 45%; background: #000; display: flex; flex-direction: column; border-right: 1px solid #444; z-index: 10; }
        #video-container { width: 100%; aspect-ratio: 16/9; background: #000; position: relative; flex-shrink: 0; }
        #player { width: 100%; height: 100%; }
        #preview-overlay { 
            position: absolute; bottom: 10%; width: 100%; text-align: center; color: white; pointer-events: none;
            font-family: 'Charis SIL', serif; font-size: 20px; text-shadow: 2px 2px 2px #000; background: rgba(0,0,0,0.4); padding: 5px 0;
            font-weight: 400; 
        }
        #global-controls { padding: 10px; background: #f8f9fa; border-top: 1px solid #ccc; overflow-y: auto; flex-grow: 1; }
        .control-group { margin-bottom: 10px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #ddd; }
        
        #right-panel { width: 55%; background: #e9ecef; display: flex; flex-direction: column; position: relative; }
        #toolbar { padding: 10px; background: #fff; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        #rows-area { flex-grow: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }

        .sub-card { background: white; border-radius: 8px; padding: 10px; margin-bottom: 12px; border-left: 5px solid #ccc; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sub-card.active { border-left-color: #007bff; background: #f0f7ff; }
        
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .idx-badge { background: #eee; color: #555; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .time-box { display: flex; align-items: center; background: #f8f9fa; border-radius: 4px; border: 1px solid #eee; }
        .time-inp { width: 65px; border: none; background: transparent; font-family: monospace; font-size: 12px; text-align: center; padding: 4px 0; }

        .format-bar { display: flex; gap: 4px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .fmt-btn { border: 1px solid #ddd; background: #f9f9f9; cursor: pointer; padding: 4px 8px; font-size: 11px; border-radius: 3px; white-space: nowrap; flex-shrink: 0; font-family: sans-serif; }
        .fmt-btn:hover { background: #e2e6ea; border-color: #adb5bd; }
        .color-wrapper { display: flex; align-items: center; border: 1px solid #ddd; padding: 0 4px; border-radius: 3px; background: #f9f9f9; }
        input[type="color"] { border: none; width: 20px; height: 20px; padding: 0; background: none; cursor: pointer; }

        .text-area { width: 100%; resize: none; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Charis SIL', serif; font-size: 16px; min-height: 80px; line-height: 1.4; }
        .text-area:focus { border-color: #007bff; }

        .btn { border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; font-size: 13px; }
        .btn-icon { background: none; border: none; font-size: 18px; padding: 0 5px; cursor: pointer; }
        
        .fw-500 { font-weight: 500; }
        .fw-600 { font-weight: 600; }

        @media (max-width: 768px) {
            #workspace { flex-direction: column; }
            #left-panel { width: 100%; height: auto; flex-shrink: 0; }
            #global-controls { display: none; } #global-controls.show { display: block; height: 150px; } 
            #right-panel { width: 100%; height: auto; flex-grow: 1; }
        }
    </style>
</head>
<body>
    <nav>
        <a href="subtitle_editor.html" class="active">üìù Subtitles</a>
        <a href="vocab_editor.html">üìñ Vocabulary</a>
        <a href="visual_editor.html">üé® Visuals</a>
        <button onclick="toggleSettings()" style="margin-left:auto; background:#444; color:#fff; border:none; padding:5px 10px; border-radius:4px; font-size:12px;">‚öôÔ∏è Config</button>
    </nav>
    <div id="workspace">
        <div id="left-panel">
            <div id="video-container"><div id="player"></div><div id="preview-overlay"></div></div>
            <div id="global-controls">
                
                <!-- GITHUB CONFIGURATION & LOAD -->
                <div class="control-group">
                    <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">GitHub Configuration</div>
                    <input id="ghUser" placeholder="User" style="width:48%; padding:5px; margin-bottom:5px;" value="hangkapiphang">
                    <input id="ghRepo" placeholder="Repo" style="width:48%; padding:5px; margin-bottom:5px;" value="taigi">
                    <input type="password" id="ghToken" placeholder="GitHub Token (for list/saving)" style="width:100%; padding:5px;">
                </div>

                <!-- FILE LOADER WITH LIST -->
                <div class="control-group" style="background:#e3f2fd; border-color:#90caf9;">
                    <div style="font-size:12px; font-weight:bold; color:#0d47a1; margin-bottom:5px;">üìÇ Load File</div>
                    
                    <!-- NEW LIST SELECTOR -->
                    <div style="display:flex; gap:5px; margin-bottom:8px;">
                        <button class="btn" style="background:#ff9800; font-size:11px; white-space:nowrap;" onclick="fetchFileList()">üîÑ Get File List</button>
                        <select id="fileSelectDropdown" style="flex-grow:1; max-width:180px;" onchange="selectFileFromList(this.value)">
                            <option value="">(Click Get List)</option>
                        </select>
                    </div>

                    <div style="display:flex; gap:5px;">
                        <input id="targetFilename" type="text" style="flex-grow:1; padding:6px;" placeholder="Filename (e.g. suntiunn)">
                        <button class="btn" style="background:#007bff;" onclick="fetchFromGithub()">‚¨á Fetch</button>
                    </div>
                    <div style="text-align:center; margin:5px 0; font-size:11px; color:#666;">- OR -</div>
                    <button class="btn" style="background:#6c757d; width:100%;" onclick="document.getElementById('hidden-file').click()">üìÇ Open Local File</button>
                    <input type="file" id="hidden-file" accept=".json" style="display:none" onchange="loadLocalJson(this)">
                </div>

                <!-- VIDEO URL -->
                <div class="control-group">
                    <input type="text" id="videoUrl" style="width:100%; padding:8px;" placeholder="YouTube URL" onchange="loadVideo(this.value)">
                </div>

                <!-- SAVE ACTIONS -->
                 <div class="control-group">
                   // <div style="display:flex; gap:5px; margin-bottom:5px;">
                       // <button class="btn" style="background:#28a745; width:100%" onclick="downloadJson()">üíæ Download JSON</button>
                   // </div>
                   // <button class="btn" style="background:#343a40; width:100%;" onclick="uploadToGithub()">‚òÅ Update GitHub</button>
               // </div>
    <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">üíæ Save Actions</div>
    <div style="display:flex; gap:5px; margin-bottom:5px;">
        <button class="btn" style="background:#28a745; flex:1;" onclick="downloadJson()">üíæ JSON</button>
        <!-- NEW BUTTON ADDED HERE: -->
        <button class="btn" style="background:#17a2b8; flex:1;" onclick="downloadSrt()">üìÑ SRT</button>
    </div>
    <button class="btn" style="background:#343a40; width:100%;" onclick="uploadToGithub()">‚òÅ Update GitHub</button>
</div>

        
        </div>
        <div id="right-panel">
            <div id="toolbar"><button class="btn" style="background:#007bff; width:100%" onclick="addSubtitleLine()">+ Add New Line</button></div>
            <div id="rows-area"></div>
        </div>
    </div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player, subtitleData = [];
        let globalData = { vocab: [], mask: {}, settings: {} };

        function toggleSettings() { const el = document.getElementById('global-controls'); el.classList.toggle('show'); }
        
        window.onload = function() {
            ['ghUser', 'ghRepo', 'ghToken'].forEach(k => { 
                if(localStorage.getItem(k)) document.getElementById(k).value = localStorage.getItem(k); 
            });
            if(window.innerWidth < 768) document.getElementById('global-controls').style.display = 'none';
        }

        function onYouTubeIframeAPIReady() {}
        
        function loadVideo(url) {
            const id = (url.match(/[?&]v=([^&#]*)/) || url.match(/youtu\.be\/([^?&#]+)/))?.[1];
            if(!id) return; globalData.video = url;
            if(player) player.loadVideoById(id); 
            else player = new YT.Player('player', { videoId: id, events: {'onReady': e=>setInterval(checkTime, 100)} });
        }

        function checkTime() {
            if(!player || !player.getCurrentTime) return;
            const ct = player.getCurrentTime();
            document.querySelectorAll('.sub-card').forEach(r => r.classList.remove('active'));
            const sub = subtitleData.find((s, i) => {
                const match = ct >= s.start && ct <= s.end;
                if(match) document.getElementById(`card-${i}`)?.classList.add('active');
                return match;
            });
            document.getElementById('preview-overlay').innerHTML = sub ? sub.text.replace(/\n/g, '<br>') : '';
        }

        function renderEditor() {
            const c = document.getElementById('rows-area'); c.innerHTML = '';
            subtitleData.forEach((s, i) => {
                c.innerHTML += `
                    <div class="sub-card" id="card-${i}">
                        <div class="card-header">
                            <span class="idx-badge">#${i+1}</span>
                            <div class="time-box">
                                <input type="text" class="time-inp" value="${secToTime(s.start)}" onchange="updateData(${i}, 'start', this.value)">
                                <span style="font-size:10px; color:#aaa;">‚ñ∂</span>
                                <input type="text" class="time-inp" value="${secToTime(s.end)}" onchange="updateData(${i}, 'end', this.value)">
                            </div>
                            <button class="btn-icon" style="color:green" onclick="player.seekTo(${s.start}, true)">‚ñ∂</button>
                            <button class="btn-icon" style="color:red" onclick="deleteLine(${i})">‚úñ</button>
                        </div>
                        <div class="format-bar">
                            <button class="fmt-btn" onclick="applyFormat(${i}, '<b>', '</b>')" title="Bold"><b>B</b></button>
                            <button class="fmt-btn" onclick="applyFormat(${i}, '<i>', '</i>')" title="Italic"><i>I</i></button>
                            <div style="width:1px; background:#ddd; margin:0 5px;"></div>
                            <button class="fmt-btn fw-500" onclick="applyFormat(${i}, '<span style=\\'font-weight:500\\'>', '</span>')" title="Medium">Med</button>
                            <div style="width:1px; background:#ddd; margin:0 5px;"></div>
                            <div class="color-wrapper" title="Color"><input type="color" onchange="applyColor(${i}, this.value); this.value='#000000'"></div>
                        </div>
                        <textarea id="txt-${i}" class="text-area" rows="2" placeholder="Subtitle text..." onchange="updateData(${i}, 'text', this.value)">${s.text}</textarea>
                    </div>`;
            });
        }

        function applyFormat(index, startTag, endTag) {
            const el = document.getElementById('txt-' + index); if (!el) return;
            const start = el.selectionStart; const end = el.selectionEnd; const txt = el.value;
            const newText = txt.substring(0, start) + startTag + txt.substring(start, end) + endTag + txt.substring(end);
            el.value = newText; updateData(index, 'text', newText);
            el.focus(); el.selectionStart = start + startTag.length; el.selectionEnd = end + startTag.length;
        }
        function applyColor(index, color) { applyFormat(index, `<font color="${color}">`, `</font>`); }
        function updateData(i, f, v) {
            if (f === 'text') subtitleData[i].text = v; else subtitleData[i][f] = timeToSec(v);
            if(f === 'start') { subtitleData.sort((a,b)=>a.start-b.start); renderEditor(); }
        }
        function addSubtitleLine() { const t = player ? player.getCurrentTime() : 0; subtitleData.push({start:t, end:t+3, text:""}); subtitleData.sort((a,b)=>a.start-b.start); renderEditor(); }
        function deleteLine(i) { if(confirm("Delete?")) { subtitleData.splice(i,1); renderEditor(); }}

        // --- NEW DATA LOGIC ---

        // 1. Fetch File List from GitHub API
        function fetchFileList() {
            const u = document.getElementById('ghUser').value.trim();
            const r = document.getElementById('ghRepo').value.trim();
            const t = document.getElementById('ghToken').value.trim();
            const select = document.getElementById('fileSelectDropdown');

            if(!u || !r) { alert("Please enter User and Repo."); return; }

            // Save config
            localStorage.setItem('ghUser', u);
            localStorage.setItem('ghRepo', r);
            if(t) localStorage.setItem('ghToken', t);

            select.innerHTML = "<option>Loading...</option>";

            // API endpoint to list files in 'data' folder
            const url = `https://api.github.com/repos/${u}/${r}/contents/data?ref=gh-pages`;
            
            // Use token if available to increase rate limit
            const headers = t ? { 'Authorization': `token ${t}` } : {};

            fetch(url, { headers: headers })
                .then(res => {
                    if(!res.ok) throw new Error("Failed to load list (Status: " + res.status + ")");
                    return res.json();
                })
                .then(data => {
                    select.innerHTML = '<option value="">-- Select a File --</option>';
                    // Filter for .json files
                    const jsonFiles = data.filter(item => item.name.endsWith('.json'));
                    
                    if(jsonFiles.length === 0) {
                        select.innerHTML = '<option>No .json files found</option>';
                        return;
                    }

                    jsonFiles.forEach(file => {
                        const opt = document.createElement('option');
                        opt.value = file.name;
                        opt.innerText = file.name;
                        select.appendChild(opt);
                    });
                })
                .catch(err => {
                    alert("Error: " + err.message);
                    select.innerHTML = "<option>Error loading list</option>";
                });
        }

        // 2. Handle selection from dropdown
        function selectFileFromList(val) {
            if(!val) return;
            document.getElementById('targetFilename').value = val;
            fetchFromGithub(); // Auto fetch
        }

        function processJsonData(d) {
            globalData = d;
            if(d.video) { document.getElementById('videoUrl').value = d.video; loadVideo(d.video); }
            if(d.subtitle) parseSRT(d.subtitle); 
            else if (d.hiddenSub) parseSRT(decodeURIComponent(escape(atob(atob(d.hiddenSub).split('').reverse().join('')))));
            renderEditor();
        }

        function fetchFromGithub() {
            const u = document.getElementById('ghUser').value.trim();
            const r = document.getElementById('ghRepo').value.trim();
            let f = document.getElementById('targetFilename').value.trim();
            
            if(!u || !r || !f) { alert("Please ensure User, Repo, and Filename are filled."); return; }
            
            f = f.replace('.json', '');
            const url = `https://raw.githubusercontent.com/${u}/${r}/gh-pages/data/${f}.json`;
            const btn = document.querySelector('button[onclick="fetchFromGithub()"]');
            const txt = btn.innerText; btn.innerText = "‚è≥";
            
            fetch(url).then(res => {
                if (!res.ok) throw new Error("404 Not Found");
                return res.json();
            }).then(d => { processJsonData(d); btn.innerText = "‚úÖ"; setTimeout(()=>btn.innerText=txt, 1500); })
            .catch(e => { alert("Error: " + e.message); btn.innerText = txt; });
        }

        function loadLocalJson(input) {
            const r = new FileReader();
            r.onload = e => { try { processJsonData(JSON.parse(e.target.result)); } catch(e){alert("Error");} }; 
            r.readAsText(input.files[0]);
        }

        function parseSRT(srt) { 
            subtitleData = []; 
            srt.trim().split(/\n\s*\n/).forEach(b => { 
                const lines = b.split('\n'); 
                if(lines.length >= 3) { 
                    const m = lines[1].match(/(\d+:\d+:\d+[,.]\d+)\s*-->\s*(\d+:\d+:\d+[,.]\d+)/); 
                    if(m) subtitleData.push({start:timeToSec(m[1]), end:timeToSec(m[2]), text:lines.slice(2).join('\n')}); 
                } 
            }); 
        }
        
        function buildJson() { 
            let srt = ""; 
            subtitleData.forEach((s,i) => srt += `${i+1}\n${secToTime(s.start)} --> ${secToTime(s.end)}\n${s.text.replace(/\n/g, '<br>')}\n\n`); 
            globalData.subtitle = srt; 
            globalData.video = document.getElementById('videoUrl').value; 
            return JSON.stringify(globalData, null, 2); 
        }
        
        function timeToSec(t) { const p=t.replace(',','.').split(':'); return p.length===3 ? (+p[0])*3600+(+p[1])*60+(+p[2]) : 0; }
        function secToTime(s) { return new Date(s*1000).toISOString().substr(11,8)+","+(s%1).toFixed(3).substr(2); }
        
        function downloadJson() { 
            //const b = new Blob([buildJson()], {type:"application/json"}); 
            //const a = document.createElement("a"); 
            //a.href=URL.createObjectURL(b); 
            //a.download = (document.getElementById('targetFilename').value || "cinema_sub") + ".json"; 
            //a.click(); 
    let content = "";
    subtitleData.forEach((s, i) => {
        // SRT format: Index, Newline, Time --> Time, Newline, Text, Double Newline
        content += `${i + 1}\r\n`;
        content += `${secToTime(s.start)} --> ${secToTime(s.end)}\r\n`;
        // Use raw text without HTML tags for SRT
        content += `${s.text.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '')}\r\n\r\n`;
    });

    const b = new Blob([content], {type:"text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(b);
    // Use targetFilename if available, otherwise default name
    let name = document.getElementById('targetFilename').value || "cinema_sub";
    name = name.replace('.json', ''); // Remove .json extension if present
    a.download = name + ".srt";
    a.click();
}
        }
        
        function uploadToGithub() {
            const u=document.getElementById('ghUser').value;
            const r=document.getElementById('ghRepo').value;
            const t=document.getElementById('ghToken').value;
            let id = document.getElementById('targetFilename').value || prompt("Filename ID:");
            if(!id) return;
            id = id.replace('.json', '');

            localStorage.setItem('ghUser', u); localStorage.setItem('ghRepo', r); localStorage.setItem('ghToken', t);
            
            const url = `https://api.github.com/repos/${u}/${r}/contents/data/${id}.json`;
            const content = btoa(unescape(encodeURIComponent(buildJson())));
            
            fetch(url + "?ref=gh-pages", { headers:{'Authorization':`token ${t}`} })
                .then(res => { return res.status === 404 ? { sha: null } : res.json(); })
                .then(d => { 
                    fetch(url, {
                        method: 'PUT', 
                        headers: { 'Authorization': `token ${t}`, 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ message: "Update via Editor", content: content, branch: "gh-pages", sha: d.sha })
                    }).then(x => { if(x.ok) alert("‚úÖ Saved!"); else x.json().then(e => alert("Error: "+e.message)); }); 
                });
        }
    </script>
</body>
</html>