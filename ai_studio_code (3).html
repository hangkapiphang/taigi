<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Mode</title>
    <style>
        /* --- 1. LOCAL FONT DEFINITION --- */
        @font-face {
            font-family: 'Taigi Unicode';
            src: url('./font/Charis-Regular.woff2') format('woff2'); 
            font-weight: normal;
            font-style: normal;
        }

        body {
            margin: 0;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #video-container {
            position: relative;
            width: 100%;
            height: 100%;
            /* Force 16:9 aspect ratio max, but fit screen */
            max-width: 177.78vh; 
            max-height: 56.25vw; 
            margin: auto;
            background-color: #000;
        }
        #player {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* [NEW] MASK BAR STYLE */
        #mask-bar {
            position: absolute; bottom: 0; left: 0;
            width: 100%; height: 0%; background-color: #000;
            z-index: 50; pointer-events: none; transition: all 0.5s ease;
        }
        
        /* --- SUBTITLE STYLING --- */
        #subtitle {
            position: absolute;
            /* Anchored to TOP (5%) so multiple lines grow DOWNWARDS safely */
            bottom: 5%; 
            left: 50%;
            transform: translateX(-50%);
            width: 98%;
            text-align: center;
            pointer-events: none; 
            z-index: 100;
        }
        
        #subtitle span {
            background-color: rgba(0, 0, 0, 0.3); 
            color: #fff;
            
            /* Font Family is controlled by JS below (PC vs iPhone) */
            font-family: 'Taigi Unicode', 'Times New Roman', serif;
            
            /* --- PC FONT SIZE --- */
            font-size: clamp(32px, 3vw, 55px); 

            line-height: 1.6; 
            padding: 8px 16px;
            
            /* Ensures black background wraps each line individually */
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
            
            border-radius: 6px;
            /* [MODIFIED] Grey Shadow */
            text-shadow: 2px 2px 4px #444444;
        }
       /* [NEW] Support for Bold tags */
        #subtitle span b { color: #fff; text-shadow: 0 0 2px #ccc; }

        /* --- MOBILE FONT SIZE (iPhone/Android) --- */
        @media screen and (max-width: 768px) {
            #subtitle span {
                /* Bigger relative size for small screens */
                font-size: clamp(24px, 6vw, 40px);
                padding: 6px 10px;
                line-height: 1.5;
            }
        }

        /* --- CUSTOM FULLSCREEN BUTTON --- */
        /* Necessary to keep subtitles ON TOP when enlarged */
        #fs-btn {
            position: absolute;
            bottom: 10px;
            right: 20px;
            z-index: 101; 
            background: rgba(0,0,0,0.6);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #fs-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: white;
        }
        #fs-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
    </style>
</head>
<body>

    <div id="video-container">
         <!-- [NEW] MASK DIV -->
        <div id="mask-bar"></div>
        
        <div id="player"></div>
        <div id="subtitle"><span></span></div>
        
        <!-- Custom Button to Fix Layering Issue -->
        <button id="fs-btn" onclick="toggleFullscreen()">
            <svg viewBox="0 0 24 24">
                <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
            Fullscreen
        </button>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player;
        let subtitles = [];

        // --- 1. DEVICE DETECTION (PC vs iPhone) ---
        function detectDeviceAndSetFont() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const subtitleSpan = document.querySelector('#subtitle span');
            
            // Check for iPhone/iPad
            const isIOS = /iPad|iPhone|iPod/.test(userAgent) || 
                          (navigator.userAgent.includes("Mac") && "ontouchend" in document);

            if (isIOS) {
                // FIXED: Force Times New Roman on iOS to fix stacking diacritics
                subtitleSpan.style.fontFamily = "'Times New Roman', serif";
            } else {
                // Use Taigi Unicode on PC/Android
                subtitleSpan.style.fontFamily = "'Taigi Unicode', 'Times New Roman', serif";
            }
        }

        // --- 2. FULLSCREEN LOGIC ---
        function toggleFullscreen() {
            const container = document.getElementById('video-container');
            if (!document.fullscreenElement) {
                if (container.requestFullscreen) container.requestFullscreen();
                else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen(); // Safari
                else if (container.msRequestFullscreen) container.msRequestFullscreen(); // IE11
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
            }
        }

        // --- 3. MAIN INITIALIZATION ---
        function onYouTubeIframeAPIReady() {
            // Apply font fix immediately
            detectDeviceAndSetFont();

            const urlParams = new URLSearchParams(window.location.search);
            const movieId = urlParams.get('id');

            if (movieId) {
                // Fetch JSON Data
                fetch(`data/${movieId}.json`)
                    .then(r => { 
                        if(!r.ok) throw new Error("Movie data not found"); 
                        return r.json(); 
                    })
                    .then(data => {
                        // Load Video
                        if (data.video) {
                            const videoId = extractVideoId(data.video);
                            if (videoId) createPlayer(videoId);
                        }
                        // Load & Decrypt Subtitles
                        if (data.hiddenSub) {
                            const plainText = decryptSubtitle(data.hiddenSub);
                            parseSRT(plainText);
                        } 
          
                        // [NEW] Apply Mask Data
                        const mask = document.getElementById('mask-bar');
                        if (data.mask) {
                            mask.style.height = data.mask.h + "%";
                            mask.style.width  = data.mask.w + "%";
                            mask.style.bottom = data.mask.b + "%";
                            mask.style.left   = data.mask.l + "%";
                        }           
   
                 })
                    .catch(e => console.error(e));
            }
        }

        // --- 4. PLAYER CREATION ---
        function createPlayer(id) {
            player = new YT.Player('player', {
                videoId: id,
                playerVars: { 
                    'autoplay': 1, 
                    'playsinline': 1,
                    'controls': 1,
                    'rel': 0,
                    'start': 0,
                    'fs': 0,             // DISABLE native fullscreen (use our custom one)
                    'cc_load_policy': 0, // DISABLE native captions
                    'iv_load_policy': 3  // DISABLE annotations
                },
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            // Force start at 0:00 on reload
            event.target.seekTo(0);
            event.target.playVideo();
            
            setInterval(updateSubtitles, 100);

            // Double check to hide native captions
            try {
                player.unloadModule("captions");
                player.unloadModule("cc");
            } catch (e) {}
        }

        // --- 5. SUBTITLE LOGIC ---
        function updateSubtitles() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            try {
                const currentTime = player.getCurrentTime();
                const subtitle = subtitles.find(s => currentTime >= s.start && currentTime <= s.end);
                
                const textSpan = document.querySelector('#subtitle span');
                if (subtitle) {
                     // [MODIFIED] innerHTML allows HTML tags
                    textSpan.innerHTML = subtitle.text;
                    textSpan.style.display = 'inline'; 
                } else {
                    textSpan.innerHTML = '';
                    textSpan.style.display = 'none'; 
                }
            } catch (error) {}
        }

        function decryptSubtitle(scrambled) {
            try {
                let step1 = atob(scrambled);
                let step2 = step1.split('').reverse().join('');
                let step3 = decodeURIComponent(escape(atob(step2)));
                return step3;
            } catch (e) { return ""; }
        }

        function parseSRT(srtContent) {
            subtitles = [];
            const blocks = srtContent.trim().split(/\n\s*\n/);
            blocks.forEach(block => {
                const lines = block.split('\n');
                if (lines.length >= 3) {
                    const timeLine = lines[1];
                    const timeMatch = timeLine.match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
                    if (timeMatch) {
                        subtitles.push({
                            start: timeToSeconds(timeMatch[1]),
                            end: timeToSeconds(timeMatch[2]),
                            text: lines.slice(2).join('<br>')
                        });
                    }
                }
            });
        }

        function timeToSeconds(time) {
            const [hours, minutes, seconds] = time.replace(',', '.').split(':');
            return parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseFloat(seconds);
        }

        function extractVideoId(url) {
            const youtubeRegex = /[?&]v=([^&#]*)/i;
            if (youtubeRegex.test(url)) return youtubeRegex.exec(url)[1];
            const shortRegex = /youtu\.be\/([^?&#]+)/i;
            if (shortRegex.test(url)) return shortRegex.exec(url)[1];
            return null;
        }
    </script>
</body>
</html>